<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Editar Ocorrência</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'dark-primary': '#0F172A',
        'dark-secondary': '#1E293B',
        'accent': '#10B981',
        'text-light': '#F8FAFC',
        'danger': '#DC2626',
        'secondary-accent': '#3B82F6'
      },
    },
  },
};

let salas = [];
let alunos = [];
let tutores = [];
let ocorrenciaId = null;

document.addEventListener('DOMContentLoaded', async () => {
  ocorrenciaId = getOcorrenciaIdFromUrl();
  if (!ocorrenciaId) {
    alert('ID da ocorrência não informado.');
    return;
  }

  await carregarFiltros();
  await carregarOcorrencia();

  document.getElementById('sala').addEventListener('change', async (e) => {
    await carregarAlunosPorSala(e.target.value);
  });

  document.getElementById('form-ocorrencia').addEventListener('submit', async (e) => {
    e.preventDefault();
    await atualizarOcorrencia();
  });
});

function getOcorrenciaIdFromUrl() {
  const params = new URLSearchParams(window.location.search);
  return params.get('id');
}

function mostrarMsg(msg, tipo = 'info') {
  const el = document.getElementById('global-message');
  if (!el) return;
  el.textContent = msg;
  el.className = `p-3 rounded mt-4 text-white font-bold fixed top-4 right-4 z-50 max-w-sm`;
  el.style.display = 'block';

  el.classList.remove('bg-danger','bg-accent','bg-secondary-accent');
  if (tipo === 'danger') el.classList.add('bg-danger');
  else if (tipo === 'accent') el.classList.add('bg-accent');
  else el.classList.add('bg-secondary-accent');

  setTimeout(() => el.style.display = 'none', 5000);
}

async function safeFetch(url) {
  try {
    const response = await fetch(url);
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    return Array.isArray(data) ? data : [];
  } catch (error) {
    console.error(`Erro na requisição ${url}:`, error);
    return [];
  }
}

async function carregarFiltros() {
  salas = await safeFetch('/api/salas_com_ocorrencias');
  tutores = await safeFetch('/api/tutores_com_ocorrencias');

  const selectSala = document.getElementById('sala');
  selectSala.innerHTML = '<option value="">Selecione a Sala</option>';
  salas.forEach(s => selectSala.innerHTML += `<option value="${s.id}">${s.nome || s.sala}</option>`);

  const selectTutor = document.getElementById('tutor');
  selectTutor.innerHTML = '<option value="">Selecione o Tutor</option>';
  tutores.forEach(t => selectTutor.innerHTML += `<option value="${t.id}">${t.nome}</option>`);

  const selectAluno = document.getElementById('aluno');
  selectAluno.innerHTML = '<option value="">Selecione o Aluno</option>';
}

async function carregarAlunosPorSala(salaId) {
  const selectAluno = document.getElementById('aluno');
  if (!salaId) {
    selectAluno.innerHTML = '<option value="">Selecione o Aluno</option>';
    return;
  }

  alunos = await safeFetch(`/api/alunos_por_sala/${salaId}`);
  selectAluno.innerHTML = '<option value="">Selecione o Aluno</option>';
  alunos.forEach(a => selectAluno.innerHTML += `<option value="${a.id}">${a.nome}</option>`);
}

async function carregarOcorrencia() {
  const [ocorrencia] = await safeFetch(`/api/ocorrencias/${ocorrenciaId}`);
  if (!ocorrencia) {
    mostrarMsg('Ocorrência não encontrada', 'danger');
    return;
  }

  document.getElementById('sala').value = ocorrencia.sala_id || '';
  await carregarAlunosPorSala(ocorrencia.sala_id);
  document.getElementById('aluno').value = ocorrencia.aluno_id || '';
  document.getElementById('tutor').value = ocorrencia.tutor_id || '';
  document.getElementById('descricao').value = ocorrencia.descricao || '';
}

async function atualizarOcorrencia() {
  const data = {
    sala_id: document.getElementById('sala').value,
    aluno_id: document.getElementById('aluno').value,
    tutor_id: document.getElementById('tutor').value,
    descricao: document.getElementById('descricao').value
  };

  if (!data.sala_id || !data.aluno_id || !data.tutor_id || !data.descricao) {
    mostrarMsg('Preencha todos os campos!', 'danger');
    return;
  }

  try {
    const response = await fetch(`/api/ocorrencias_atualizar/${ocorrenciaId}`, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    });
    if (!response.ok) throw new Error('Erro ao atualizar ocorrência');
    mostrarMsg('Ocorrência atualizada com sucesso!', 'accent');
  } catch (e) {
    console.error(e);
    mostrarMsg('Falha ao atualizar ocorrência', 'danger');
  }
}
</script>
</head>
<body class="bg-dark-primary text-text-light min-h-screen flex flex-col">

<!-- Cabeçalho -->
<header class="bg-dark-secondary p-4 shadow-md flex justify-between items-center">
  <h1 class="text-xl font-bold">Sistema de Gestão de Convivência Escolar</h1>
  <nav class="space-x-4">
    <a href="/gestao_ocorrencia" class="text-white font-medium hover:underline">Gestão Ocorrências</a>
    <a href="/gestao_frequencia" class="text-white font-medium hover:underline">Gestão Frequência</a>
    <button class="text-gray-500 cursor-not-allowed" disabled>Em Desenvolvimento</button>
  </nav>
</header>

<!-- Mensagem global -->
<div id="global-message" style="display:none;"></div>

<!-- Formulário de Edição de Ocorrência -->
<section class="p-4 flex-1">
  <form id="form-ocorrencia" class="bg-dark-secondary p-6 rounded shadow-md max-w-lg mx-auto flex flex-col gap-4">
    <label class="flex flex-col">
      Sala
      <select id="sala" class="p-2 rounded bg-gray-700 text-white"></select>
    </label>
    <label class="flex flex-col">
      Aluno
      <select id="aluno" class="p-2 rounded bg-gray-700 text-white"></select>
    </label>
    <label class="flex flex-col">
      Tutor
      <select id="tutor" class="p-2 rounded bg-gray-700 text-white"></select>
    </label>
    <label class="flex flex-col">
      Descrição
      <textarea id="descricao" rows="4" class="p-2 rounded bg-gray-700 text-white"></textarea>
    </label>
    <button type="submit" class="bg-accent text-dark-primary font-bold py-2 rounded hover:bg-green-500 transition">Atualizar Ocorrência</button>
  </form>
</section>

<!-- Rodapé -->
<footer class="bg-dark-secondary p-4 text-center text-gray-400 mt-auto">
  © 2025 SGCE - Todos os direitos reservados
</footer>
</body>
</html>
