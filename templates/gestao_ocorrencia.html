<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gest√£o de Ocorr√™ncias</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'dark-primary': '#0F172A',
        'dark-secondary': '#1E293B',
        'accent': '#10B981',
        'text-light': '#F8FAFC',
        'danger': '#DC2626',
        'secondary-accent': '#3B82F6',
        'tutor-color': '#007ACC',
        'coord-color': '#F59E0B',
        'gestao-color': '#EF4444'
      },
    },
  },
};

let ocorrencias = [];
let salas = [];
let alunos = [];
let tutores = [];

document.addEventListener('DOMContentLoaded', async () => {
  await carregarFiltros();
  await carregarOcorrencias();

  document.getElementById('filtro-sala').addEventListener('change', async (e) => {
    await carregarAlunosPorSala(e.target.value);
    await aplicarFiltros();
  });
  document.getElementById('filtro-aluno').addEventListener('change', aplicarFiltros);
  document.getElementById('filtro-tutor').addEventListener('change', aplicarFiltros);
  document.getElementById('filtro-status').addEventListener('change', aplicarFiltros);
});

function mostrarMsg(msg, tipo = 'info') {
    const el = document.getElementById('global-message');
    if (!el) return;
    el.textContent = msg;
    el.className = `p-3 rounded mt-4 text-white font-bold fixed top-4 right-4 z-50 max-w-sm`;
    el.style.display = 'block';

    el.classList.remove('bg-danger','bg-accent','bg-secondary-accent');
    if (tipo === 'danger') el.classList.add('bg-danger');
    else if (tipo === 'accent') el.classList.add('bg-accent');
    else el.classList.add('bg-secondary-accent');

    setTimeout(() => el.style.display = 'none', 5000);
}

async function safeFetch(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const data = await response.json();
        return Array.isArray(data) ? data : [];
    } catch (error) {
        console.error(`Erro na requisi√ß√£o ${url}:`, error);
        return [];
    }
}

async function carregarFiltros() {
  try {
    salas = await safeFetch('/api/salas_com_ocorrencias');
    const selectSala = document.getElementById('filtro-sala');
    selectSala.innerHTML = '<option value="all">Todas as Salas</option>';
    salas.forEach(s => selectSala.innerHTML += `<option value="${s.id}">${s.nome || s.sala}</option>`);

    tutores = await safeFetch('/api/tutores_com_ocorrencias');
    const selectTutor = document.getElementById('filtro-tutor');
    selectTutor.innerHTML = '<option value="all">Todos os Tutores</option>';
    tutores.forEach(t => selectTutor.innerHTML += `<option value="${t.id}">${t.nome}</option>`);

    const selectStatus = document.getElementById('filtro-status');
    selectStatus.innerHTML = `
      <option value="all">Todos os Status</option>
      <option value="ATENDIMENTO">Atendimento</option>
      <option value="FINALIZADA">Finalizada</option>
      <option value="ASSINADA">Assinada</option>
    `;

    const selectAluno = document.getElementById('filtro-aluno');
    selectAluno.innerHTML = '<option value="all">Todos os Alunos</option>';

  } catch (e) {
    console.error('Erro ao carregar filtros:', e);
    mostrarMsg('Erro ao carregar filtros', 'danger');
  }
}

async function carregarAlunosPorSala(salaId) {
  const selectAluno = document.getElementById('filtro-aluno');
  selectAluno.innerHTML = '<option value="all">Carregando...</option>';

  if (salaId === 'all') {
    selectAluno.innerHTML = '<option value="all">Todos os Alunos</option>';
    return;
  }

  try {
    alunos = await safeFetch(`/api/alunos_por_sala/${salaId}`);
    selectAluno.innerHTML = '<option value="all">Todos os Alunos</option>';
    alunos.forEach(a => selectAluno.innerHTML += `<option value="${a.id}">${a.nome}</option>`);
  } catch (e) {
    console.error('Erro ao carregar alunos:', e);
    selectAluno.innerHTML = '<option value="all">Erro ao carregar</option>';
  }
}

async function carregarOcorrencias() {
  try {
    ocorrencias = await safeFetch('/api/ocorrencias_todas');
    renderizarOcorrencias();
  } catch (e) {
    console.error('Erro ao carregar ocorr√™ncias:', e);
    mostrarMsg('Erro ao carregar ocorr√™ncias', 'danger');
  }
}

async function aplicarFiltros() {
  const salaId = document.getElementById('filtro-sala').value;
  const tutorId = document.getElementById('filtro-tutor').value;
  const status = document.getElementById('filtro-status').value;
  const alunoId = document.getElementById('filtro-aluno').value;

  let url = '/api/ocorrencias_filtrar?';
  const params = [];
  if (salaId !== 'all') params.push(`sala_id=${salaId}`);
  if (tutorId !== 'all') params.push(`tutor_id=${tutorId}`);
  if (status !== 'all') params.push(`status=${status}`);
  if (alunoId !== 'all') params.push(`aluno_id=${alunoId}`);
  url += params.join('&');

  try {
    ocorrencias = await safeFetch(url);
    renderizarOcorrencias();
  } catch (e) {
    console.error('Erro ao filtrar ocorr√™ncias:', e);
    mostrarMsg('Erro ao aplicar filtros', 'danger');
  }
}

function renderizarOcorrencias() {
  const tbody = document.getElementById('ocorrencias-body');
  if (!ocorrencias.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="9" class="text-center py-6 text-gray-400">
          Nenhuma ocorr√™ncia encontrada
        </td>
      </tr>
    `;
    return;
  }

  tbody.innerHTML = ocorrencias.map(oc => `
    <tr class="border-b border-gray-700 hover:bg-gray-800/50">
      <td class="p-3 text-sm">
        <input type="checkbox" value="${oc.numero}" class="h-4 w-4 accent-accent"
               ${oc.impressao_pdf ? 'disabled checked' : ''} onchange="atualizarSelecao()">
      </td>
      <td class="p-3 text-sm font-medium text-accent">${oc.numero}</td>
      <td class="p-3 text-sm">${formatarData(oc.data_hora || oc.data)}</td>
      <td class="p-3 text-sm">${oc.aluno_nome || oc.aluno || 'N/A'}</td>
      <td class="p-3 text-sm">${oc.sala_nome || oc.sala || 'N/A'}</td>
      <td class="p-3 text-sm">${oc.professor_nome || oc.professor || 'N/A'}</td>
      <td class="p-3 text-sm">${oc.tutor_nome || oc.tutor || 'N/A'}</td>
      <td class="p-3 text-sm">
        <span class="px-2 py-1 rounded-full text-xs font-medium ${getStatusClass(oc.status)}">
          ${oc.status || 'N/A'}
        </span>
      </td>
      <td class="p-3 text-sm">
        <div class="flex space-x-2 items-center">
          <a href="/gestao_ocorrencia_editar?id=${oc.numero}" class="text-blue-400 hover:text-blue-300 transition" title="Visualizar">üëÅÔ∏è</a>
          ${renderizarAcoes(oc)}
          ${oc.impressao_pdf ? `<span class="text-green-400" title="PDF j√° gerado">‚úÖ</span>` : ''}
        </div>
      </td>
    </tr>
  `).join('');

  atualizarSelecao();
}

function renderizarAcoes(ocorrencia) {
  if (ocorrencia.status === 'FINALIZADA') {
    return `<a href="/gerar_pdf?id=${ocorrencia.numero}" class="text-green-400 hover:text-green-300 transition" title="Gerar PDF">üìÑ</a>`;
  }
  return '';
}

function getStatusClass(status) {
  switch (status) {
    case 'ATENDIMENTO': return 'bg-secondary-accent text-white';
    case 'FINALIZADA': return 'bg-accent text-white';
    case 'ASSINADA': return 'bg-tutor-color text-white';
    default: return 'bg-gray-600 text-white';
  }
}

function formatarData(dt) {
  if (!dt) return '';
  const d = new Date(dt);
  return d.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
}

function atualizarSelecao() {
  const checkboxes = document.querySelectorAll('#ocorrencias-body input[type="checkbox"]:not([disabled])');
  const btn = document.getElementById('btn-gerar-pdf');
  btn.disabled = !Array.from(checkboxes).some(c => c.checked);
}
</script>
</head>
<body class="bg-dark-primary text-text-light min-h-screen flex flex-col">
<!-- Cabe√ßalho -->
<header class="bg-dark-secondary p-4 shadow-md flex justify-between items-center">
  <h1 class="text-xl font-bold">Sistema de Gest√£o de Conviv√™ncia Escolar</h1>
  <nav class="space-x-4">
    <a href="/gestao_ocorrencia" class="text-white font-medium hover:underline">Gest√£o Ocorr√™ncias</a>
    <a href="/gestao_frequencia" class="text-white font-medium hover:underline">Gest√£o Frequ√™ncia</a>
    <button class="text-gray-500 cursor-not-allowed" disabled>Em Desenvolvimento</button>
  </nav>
</header>

<!-- Mensagem global -->
<div id="global-message" style="display:none;"></div>

<!-- Filtros -->
<section class="p-4 flex flex-wrap gap-4 bg-dark-secondary">
  <select id="filtro-sala" class="p-2 rounded bg-gray-700 text-white"></select>
  <select id="filtro-aluno" class="p-2 rounded bg-gray-700 text-white"></select>
  <select id="filtro-tutor" class="p-2 rounded bg-gray-700 text-white"></select>
  <select id="filtro-status" class="p-2 rounded bg-gray-700 text-white"></select>
</section>

<!-- Tabela de ocorr√™ncias -->
<section class="flex-1 overflow-x-auto p-4">
  <table class="min-w-full divide-y divide-gray-700">
    <thead class="bg-dark-secondary text-left text-sm uppercase font-medium text-gray-300">
      <tr>
        <th class="p-3"><input type="checkbox" disabled></th>
        <th class="p-3">#</th>
        <th class="p-3">Data</th>
        <th class="p-3">Aluno</th>
        <th class="p-3">Sala</th>
        <th class="p-3">Professor</th>
        <th class="p-3">Tutor</th>
        <th class="p-3">Status</th>
        <th class="p-3">A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="ocorrencias-body">
      <tr><td colspan="9" class="text-center py-6 text-gray-400">Carregando...</td></tr>
    </tbody>
  </table>
</section>

<!-- Rodap√© -->
<footer class="bg-dark-secondary p-4 text-center text-gray-400 mt-auto">
  ¬© 2025 SGCE - Todos os direitos reservados
</footer>
</body>
</html>
