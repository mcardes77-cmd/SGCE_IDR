<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Impressão de Ocorrências</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        'dark-primary': '#0F172A',
        'dark-secondary': '#1E293B',
        'accent': '#10B981',
        'text-light': '#F8FAFC',
        'danger': '#DC2626',
        'secondary-accent': '#3B82F6'
      },
    },
  },
};

let salas = [];
let alunos = [];
let ocorrencias = [];
let nomeAlunoAtual = "";

document.addEventListener('DOMContentLoaded', async () => {
  await carregarSalas();
  document.getElementById('filter-sala').addEventListener('change', carregarAlunos);
});

function mostrarMsg(msg, tipo = 'info') {
    const el = document.getElementById('global-message');
    if (!el) return;
    el.textContent = msg;
    el.className = `p-3 rounded mt-4 text-white font-bold`;
    el.style.display = 'block';

    if (tipo === 'danger') {
        el.classList.add('bg-danger');
    } else if (tipo === 'accent') {
        el.classList.add('bg-accent');
    } else {
        el.classList.add('bg-secondary-accent');
    }

    setTimeout(() => el.style.display = 'none', 5000);
}

async function carregarSalas() {
  const sel = document.getElementById('filter-sala');
  sel.innerHTML = '<option>Carregando...</option>';
  try {
    const resp = await fetch('/api/salas_com_ocorrencias');
    salas = await resp.json();
    sel.innerHTML = '<option value="">Selecione a Sala</option>';
    salas.forEach(s => {
      const nomeSala = s.sala || s.nome || 'Sem nome';
      const idSala = s.id || s.id_sala || s.numero || '';
      sel.innerHTML += `<option value="${idSala}">${nomeSala}</option>`;
    });
    mostrarMsg('Salas carregadas.', 'accent');
  } catch (e) {
    console.error('Erro ao carregar salas:', e);
    sel.innerHTML = '<option value="">Erro ao carregar salas</option>';
    mostrarMsg('Erro ao carregar salas. Verifique a API.', 'danger');
  }
}

async function carregarAlunos() {
  const sala = document.getElementById('filter-sala').value;
  const sel = document.getElementById('filter-aluno');
  sel.innerHTML = '<option>Carregando...</option>';
  if (!sala) {
    sel.innerHTML = '<option value="">Selecione uma sala primeiro</option>';
    ocorrencias = [];
    renderizarOcorrencias();
    return;
  }
  try {
    const resp = await fetch(`/api/alunos_com_ocorrencias_por_sala/${sala}`);
    alunos = await resp.json();
    sel.innerHTML = '<option value="">Selecione o Aluno</option>';
    alunos.forEach(a => {
      const nomeAluno = a.nome || a.aluno_nome || 'Sem nome';
      const idAluno = a.id || a.id_aluno || a.matricula || '';
      sel.innerHTML += `<option value="${idAluno}">${nomeAluno}</option>`;
    });
    ocorrencias = [];
    renderizarOcorrencias();
  } catch (e) {
    console.error('Erro ao carregar alunos:', e);
    sel.innerHTML = '<option value="">Erro ao carregar alunos</option>';
    mostrarMsg('Erro ao carregar alunos. Verifique a API.', 'danger');
  }
}

async function buscarOcorrencias() {
  const aluno = document.getElementById('filter-aluno').value;
  if (!aluno) {
    mostrarMsg('Selecione o aluno para buscar as ocorrências.', 'danger');
    return;
  }
  
  mostrarMsg('Buscando ocorrências...', 'secondary-accent');
  
  try {
      const resp = await fetch(`/api/ocorrencias_por_aluno/${aluno}`);
      ocorrencias = await resp.json();
      
      if (!resp.ok) {
          throw new Error(ocorrencias.error || 'Falha ao buscar ocorrências.');
      }

      nomeAlunoAtual = ocorrencias[0]?.aluno_nome || alunos.find(a => a.id == aluno)?.nome || "Aluno Desconhecido";
      
      renderizarOcorrencias();
      mostrarMsg(`${ocorrencias.length} ocorrência(s) encontrada(s) para ${nomeAlunoAtual}.`, 'accent');
      
  } catch (e) {
      console.error('Erro ao buscar ocorrências:', e);
      ocorrencias = [];
      renderizarOcorrencias();
      mostrarMsg(`Erro na busca: ${e.message}`, 'danger');
  }
}

function renderizarOcorrencias() {
  const div = document.getElementById('ocorrencias-lista');
  if (!ocorrencias.length) {
    div.innerHTML = '<p class="text-gray-400 text-center">Nenhuma ocorrência encontrada.</p>';
    return;
  }
  
  div.innerHTML = ocorrencias.map(o => `
    <div class="flex items-start gap-3 border-b border-gray-700 py-3 ${o.impressao_pdf ? 'bg-gray-800' : ''}">
      <input type="checkbox" 
             value="${o.numero}" 
             class="mt-1 h-4 w-4 accent-accent"
             ${o.impressao_pdf ? 'disabled' : ''}
             ${o.impressao_pdf ? 'checked' : ''}>
      <div class="flex-1">
        <p class="font-bold text-lg text-accent-light">
          Nº ${o.numero} - ${o.status}
          ${o.impressao_pdf ? '<span class="text-xs bg-green-600 text-white px-2 py-1 rounded ml-2">IMPRESSO</span>' : ''}
        </p>
        <p class="text-sm text-gray-400"><strong>Data:</strong> ${new Date(o.data_hora).toLocaleString('pt-BR')}</p>
        <p class="text-sm text-gray-400"><strong>Tipo:</strong> ${o.tipo}</p>
        <p class="mt-1"><strong>Descrição:</strong> ${o.descricao}</p>
      </div>
    </div>
  `).join('');
}

// --- Função gerarPDF corrigida ---
async function gerarPDF() {
    const selecionadas = [...document.querySelectorAll('#ocorrencias-lista input:checked:not(:disabled)')]
        .map(c => parseInt(c.value))
        .filter(n => !isNaN(n));

    if (!selecionadas.length) {
        mostrarMsg('Selecione pelo menos uma ocorrência para gerar o PDF.', 'danger');
        return;
    }

    mostrarMsg('Gerando PDF...', 'secondary-accent');

    try {
        const response = await fetch('/api/gerar_pdf_ocorrencias', {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ numeros: selecionadas })
        });

        if (!response.ok) {
            let errorData = {};
            try { errorData = await response.json(); } catch {}
            throw new Error(errorData.error || `Falha ao gerar PDF (HTTP ${response.status})`);
        }

        // Criar blob do PDF
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);

        // Criar link para download
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `ocorrencias_${nomeAlunoAtual.replace(/\s/g,'_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        document.body.appendChild(a);
        a.click();

        // Limpar
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);

        mostrarMsg(`PDF gerado com sucesso para ${selecionadas.length} ocorrência(s)!`, 'accent');

        // Recarregar ocorrências para atualizar status das impressas
        setTimeout(() => buscarOcorrencias(), 1000);

    } catch (e) {
        console.error('Erro ao gerar PDF:', e);
        mostrarMsg('Erro ao gerar PDF: ' + e.message, 'danger');
    }
}
</script>
</head>

<body class="bg-dark-primary text-text-light min-h-screen p-6">
    <div id="global-message" style="display: none;"></div>
    
  <header class="w-full text-center mb-8 mt-4">
    <h1 class="text-3xl sm:text-4xl font-extrabold text-secondary-accent leading-tight tracking-wider">
      SISTEMA DE GESTÃO DE CONVIVÊNCIA ESCOLAR
    </h1>
    <h2 class="text-xl sm:text-2xl text-text-light mt-2 font-light border-b border-gray-700 pb-2 inline-block">
      GESTÃO DE RELATÓRIOS - IMPRESSÃO DE OCORRÊNCIAS
    </h2>

    <button onclick="window.location.href='/gestao_ocorrencia'" 
      class="mt-4 px-4 py-2 text-sm font-medium rounded-lg text-gray-300 border border-gray-600 hover:bg-gray-700 transition duration-150 flex items-center mx-auto">
      <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path>
      </svg>
      Voltar ao Menu de Ocorrências
    </button>
  </header>

  <main class="max-w-4xl mx-auto space-y-6">
    <section class="bg-dark-secondary p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-accent">Filtros</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label for="filter-sala" class="block mb-1 text-sm text-gray-300">Sala:</label>
          <select id="filter-sala" class="w-full p-2 rounded text-black"></select>
        </div>
        <div>
          <label for="filter-aluno" class="block mb-1 text-sm text-gray-300">Aluno:</label>
          <select id="filter-aluno" class="w-full p-2 rounded text-black"></select>
        </div>
      </div>
      <button onclick="buscarOcorrencias()" 
        class="mt-4 bg-danger px-4 py-2 rounded text-white font-semibold hover:bg-red-700 w-full">
        Buscar Ocorrências
      </button>
    </section>

    <section class="bg-dark-secondary p-6 rounded-lg shadow-lg">
      <h3 class="text-xl font-semibold border-b border-gray-600 pb-2 mb-4 text-accent">Ocorrências Encontradas</h3>
      <div id="ocorrencias-lista" class="space-y-2">
        <p class="text-gray-400 text-center">Use os filtros acima para carregar as ocorrências.</p>
      </div>
      <button onclick="gerarPDF()" 
        class="mt-6 bg-accent px-4 py-3 rounded-lg text-white font-bold w-full hover:bg-emerald-700">
        Gerar PDF das Ocorrências Selecionadas
      </button>
      <p class="text-sm text-gray-400 mt-2">
        <strong>Nota:</strong> As ocorrências já impressas aparecem em cinza e não podem ser selecionadas novamente.
      </p>
    </section>
  </main>

  <footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
    <p class="mb-1 text-base font-medium">
      DESENVOLVEDOR: MARCELO ANDRÉ NOGUEIRA CARDES
    </p>
    <p class="text-xs font-light tracking-wide">
      LICENCIADO: E.E. PEI PROFESSORA IRENE DIAS RIBEIRO
    </p>
  </footer>
</body>
</html>
