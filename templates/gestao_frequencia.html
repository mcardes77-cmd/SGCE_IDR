<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de Frequ√™ncia</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-primary': '#0F172A',
                        'dark-secondary': '#1E293B',
                        'accent': '#10B981',
                        'text-light': '#F8FAFC',
                        'danger': '#DC2626',
                        'warning': '#FACC15',
                        'secondary-accent': '#3B82F6',
                        'alert-warning': '#F59E0B',
                        'alert-danger': '#DC2626'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };

        // Configura√ß√£o do Supabase
        const supabaseUrl = 'SUA_URL_DO_SUPABASE';
        const supabaseKey = 'SUA_CHAVE_DO_SUPABASE';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        let moduloAtual = 'menu';
        let dadosFrequencia = [];
        let salasData = [];
        let alunosData = [];
        let frequenciaData = {};
        let isLocked = false;

        document.addEventListener('DOMContentLoaded', async () => {
            await carregarSalas();
            mostrarModulo('menu');
            
            // Configurar event listeners para os m√≥dulos
            configurarModuloRegistro();
            configurarModuloAtraso();
            configurarModuloSaida();
            configurarModuloRelatorio();
        });

        function mostrarModulo(modulo) {
            moduloAtual = modulo;
            
            // Esconder todos os m√≥dulos
            document.querySelectorAll('[id^="modulo-"]').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Mostrar m√≥dulo selecionado
            document.getElementById(`modulo-${modulo}`).classList.remove('hidden');
            
            // Atualizar bot√µes de navega√ß√£o
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-accent', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            });
            
            const btnAtivo = document.querySelector(`[onclick="mostrarModulo('${modulo}')"]`);
            if (btnAtivo) {
                btnAtivo.classList.add('bg-accent', 'text-white');
                btnAtivo.classList.remove('bg-gray-700', 'text-gray-300');
            }
        }

        function mostrarMsg(msg, tipo = 'info') {
            const el = document.getElementById('global-message');
            if (!el) return;
            
            el.textContent = msg;
            el.className = 'p-3 rounded mt-4 text-white font-bold fixed top-4 right-4 z-50 max-w-sm';
            el.style.display = 'block';
            el.classList.remove('bg-danger', 'bg-accent', 'bg-secondary-accent', 'bg-warning');
            
            if (tipo === 'danger') el.classList.add('bg-danger');
            else if (tipo === 'accent') el.classList.add('bg-accent');
            else if (tipo === 'warning') el.classList.add('bg-warning');
            else el.classList.add('bg-secondary-accent');
            
            setTimeout(() => el.style.display = 'none', 5000);
        }

        // ========== FUN√á√ïES SUPABASE ==========

        async function carregarSalas() {
            try {
                const { data, error } = await supabase
                    .from('d_alunos')
                    .select('sala_id, sala_nome')
                    .not('sala_id', 'is', null)
                    .order('sala_nome');

                if (error) throw error;

                // Remover duplicatas
                const salasUnicas = [];
                const idsVistos = new Set();
                
                data.forEach(item => {
                    if (item.sala_id && !idsVistos.has(item.sala_id)) {
                        idsVistos.add(item.sala_id);
                        salasUnicas.push({
                            id: item.sala_id,
                            nome: item.sala_nome
                        });
                    }
                });

                salasData = salasUnicas;
                
                // Atualizar todos os selects de sala
                document.querySelectorAll('.select-sala').forEach(select => {
                    select.innerHTML = '<option value="">Selecione a Sala</option>';
                    salasData.forEach(sala => {
                        select.innerHTML += `<option value="${sala.id}">${sala.nome}</option>`;
                    });
                });
            } catch (error) {
                console.error('Erro ao carregar salas:', error);
                mostrarMsg('Erro ao carregar salas', 'danger');
            }
        }

        async function carregarAlunosPorSala(salaId) {
            try {
                const { data, error } = await supabase
                    .from('d_alunos')
                    .select('id, aluno_nome, sala_nome')
                    .eq('sala_id', salaId)
                    .order('aluno_nome');

                if (error) throw error;

                return data || [];
            } catch (error) {
                console.error('Erro ao carregar alunos:', error);
                mostrarMsg('Erro ao carregar alunos', 'danger');
                return [];
            }
        }

        async function verificarFrequenciaRegistrada(salaId, data) {
            try {
                // Primeiro busca alunos da sala
                const alunos = await carregarAlunosPorSala(salaId);
                if (alunos.length === 0) return false;

                const { data: frequencia, error } = await supabase
                    .from('f_frequencia')
                    .select('id')
                    .in('aluno_nome', alunos.map(a => a.aluno_nome))
                    .eq('data', data)
                    .limit(1);

                if (error) throw error;

                return frequencia && frequencia.length > 0;
            } catch (error) {
                console.error('Erro ao verificar frequ√™ncia:', error);
                return false;
            }
        }

        async function salvarFrequenciaSupabase(registros) {
            try {
                const { data, error } = await supabase
                    .from('f_frequencia')
                    .upsert(registros, { 
                        onConflict: 'aluno_nome,data',
                        ignoreDuplicates: false 
                    });

                if (error) throw error;

                return { success: true, message: 'Frequ√™ncia salva com sucesso!' };
            } catch (error) {
                console.error('Erro ao salvar frequ√™ncia:', error);
                return { success: false, error: error.message };
            }
        }

        async function salvarAtrasoSupabase(dados) {
            try {
                // Busca dados do aluno
                const { data: aluno, error: alunoError } = await supabase
                    .from('d_alunos')
                    .select('aluno_nome, sala_nome')
                    .eq('id', dados.aluno_id)
                    .single();

                if (alunoError) throw alunoError;

                // Salva/atualiza na f_frequencia
                const { error: freqError } = await supabase
                    .from('f_frequencia')
                    .upsert({
                        aluno_nome: aluno.aluno_nome,
                        sala_nome: aluno.sala_nome,
                        data: dados.data,
                        status: 'PA',
                        hora_entrada: dados.hora_entrada,
                        motivo_atraso: dados.motivo_atraso,
                        responsavel_nome: dados.responsavel_nome,
                        responsavel_telefone: dados.responsavel_telefone,
                        updated_at: new Date()
                    }, {
                        onConflict: 'aluno_nome,data'
                    });

                if (freqError) throw freqError;

                return { success: true, message: 'Atraso registrado com sucesso!' };
            } catch (error) {
                console.error('Erro ao salvar atraso:', error);
                return { success: false, error: error.message };
            }
        }

        async function salvarSaidaSupabase(dados) {
            try {
                // Busca dados do aluno
                const { data: aluno, error: alunoError } = await supabase
                    .from('d_alunos')
                    .select('aluno_nome, sala_nome')
                    .eq('id', dados.aluno_id)
                    .single();

                if (alunoError) throw alunoError;

                // Busca registro existente para determinar status
                const { data: registroExistente, error: buscaError } = await supabase
                    .from('f_frequencia')
                    .select('status')
                    .eq('aluno_nome', aluno.aluno_nome)
                    .eq('data', dados.data)
                    .single();

                let status = 'PS'; // Presen√ßa com Sa√≠da Antecipada
                
                // Se j√° tiver atraso, atualiza para PSA
                if (registroExistente && registroExistente.status === 'PA') {
                    status = 'PSA';
                }

                // Salva/atualiza na f_frequencia
                const { error: freqError } = await supabase
                    .from('f_frequencia')
                    .upsert({
                        aluno_nome: aluno.aluno_nome,
                        sala_nome: aluno.sala_nome,
                        data: dados.data,
                        status: status,
                        hora_saida: dados.hora_saida,
                        motivo_saida: dados.motivo_saida,
                        responsavel_nome: dados.responsavel_nome,
                        responsavel_telefone: dados.responsavel_telefone,
                        updated_at: new Date()
                    }, {
                        onConflict: 'aluno_nome,data'
                    });

                if (freqError) throw freqError;

                return { success: true, message: 'Sa√≠da antecipada registrada com sucesso!' };
            } catch (error) {
                console.error('Erro ao salvar sa√≠da antecipada:', error);
                return { success: false, error: error.message };
            }
        }

        async function carregarRelatorioMensal(salaId, mes) {
            try {
                const ano = new Date().getFullYear();
                const dataInicio = `${ano}-${mes.toString().padStart(2, '0')}-01`;
                const dataFim = `${ano}-${mes.toString().padStart(2, '0')}-${new Date(ano, mes, 0).getDate()}`;

                // Carrega alunos da sala
                const { data: alunos, error: alunosError } = await supabase
                    .from('d_alunos')
                    .select('id, aluno_nome')
                    .eq('sala_id', salaId)
                    .order('aluno_nome');

                if (alunosError) throw alunosError;

                if (!alunos || alunos.length === 0) return [];

                // Carrega frequ√™ncia do per√≠odo
                const { data: frequencia, error: freqError } = await supabase
                    .from('f_frequencia')
                    .select('*')
                    .in('aluno_nome', alunos.map(a => a.aluno_nome))
                    .gte('data', dataInicio)
                    .lte('data', dataFim);

                if (freqError) throw freqError;

                // Processa os dados para o formato do relat√≥rio
                const relatorio = alunos.map(aluno => {
                    const frequenciaAluno = {};
                    
                    // Processa frequ√™ncia
                    frequencia.filter(f => f.aluno_nome === aluno.aluno_nome).forEach(f => {
                        frequenciaAluno[f.data] = {
                            status: f.status,
                            hora_entrada: f.hora_entrada,
                            hora_saida: f.hora_saida,
                            motivo_atraso: f.motivo_atraso,
                            motivo_saida: f.motivo_saida,
                            responsavel_nome: f.responsavel_nome,
                            responsavel_telefone: f.responsavel_telefone
                        };
                    });

                    return {
                        id: aluno.id,
                        nome: aluno.aluno_nome,
                        frequencia: frequenciaAluno
                    };
                });

                return relatorio;
            } catch (error) {
                console.error('Erro ao carregar relat√≥rio:', error);
                throw error;
            }
        }

        async function carregarDetalhesFrequencia(alunoId, data) {
            try {
                // Busca nome do aluno
                const { data: aluno, error: alunoError } = await supabase
                    .from('d_alunos')
                    .select('aluno_nome')
                    .eq('id', alunoId)
                    .single();

                if (alunoError) throw alunoError;

                // Busca detalhes da frequ√™ncia
                const { data: frequencia, error: freqError } = await supabase
                    .from('f_frequencia')
                    .select('*')
                    .eq('aluno_nome', aluno.aluno_nome)
                    .eq('data', data)
                    .single();

                if (freqError && freqError.code !== 'PGRST116') throw freqError;

                return frequencia || {};
            } catch (error) {
                console.error('Erro ao carregar detalhes:', error);
                return {};
            }
        }

        // ========== M√ìDULO REGISTRO DE FREQU√äNCIA ==========
        function configurarModuloRegistro() {
            const selectSala = document.getElementById('select-sala-registro');
            const inputData = document.getElementById('input-data-registro');
            
            if (selectSala && inputData) {
                selectSala.addEventListener('change', checkFrequencyStatus);
                inputData.addEventListener('change', checkFrequencyStatus);
            }
            
            const btnSalvar = document.getElementById('btn-salvar-frequencia');
            if (btnSalvar) {
                btnSalvar.addEventListener('click', saveFrequency);
            }
        }

        async function loadAlunosRegistro(sala_id) {
            try {
                alunosData = await carregarAlunosPorSala(sala_id);
                renderAlunosList();
            } catch {
                mostrarMsg('Erro ao carregar alunos.', 'danger');
            }
        }

        async function checkFrequencyStatus() {
            const salaId = document.getElementById('select-sala-registro').value;
            const data = document.getElementById('input-data-registro').value;
            const alunosContainer = document.getElementById('alunos-list-container');
            const statusDiv = document.getElementById('registro-status');
            const mensagemTravada = document.getElementById('mensagem-travada');

            alunosContainer.classList.add('hidden');
            mensagemTravada.classList.add('hidden');
            statusDiv.innerHTML = '';
            document.getElementById('btn-salvar-frequencia').classList.add('hidden');
            frequenciaData = {};
            isLocked = false;

            if (!salaId || !data) return;

            try {
                const registrada = await verificarFrequenciaRegistrada(salaId, data);

                if (registrada) {
                    statusDiv.innerHTML = `<span class="text-accent font-bold">Frequ√™ncia j√° registrada.</span>`;
                    isLocked = true;
                    mensagemTravada.classList.remove('hidden');
                } else {
                    statusDiv.innerHTML = `<span class="text-secondary-accent font-bold">Frequ√™ncia pendente.</span>`;
                    alunosContainer.classList.remove('hidden');
                    document.getElementById('btn-salvar-frequencia').classList.remove('hidden');
                    loadAlunosRegistro(salaId);
                }
            } catch {
                mostrarMsg('Erro ao verificar status.', 'danger');
            }
        }

        function renderAlunosList() {
            const tbody = document.getElementById('alunos-list-body');
            tbody.innerHTML = '';

            alunosData.forEach(aluno => {
                const currentStatus = frequenciaData[aluno.id] || 'P';
                frequenciaData[aluno.id] = currentStatus;
                const colorClass = currentStatus === 'P' ? 'status-P' : 'status-F';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-700 hover:bg-dark-primary transition';
                tr.innerHTML = `
                    <td class="p-3 text-left">${aluno.aluno_nome}</td>
                    <td class="p-3 text-center">
                        <div id="btn-${aluno.id}" class="status-btn ${colorClass}">
                            ${currentStatus}
                        </div>
                    </td>
                `;

                tr.querySelector(`#btn-${aluno.id}`).addEventListener('click', (e) => {
                    const btn = e.currentTarget;
                    if (btn.classList.contains('status-P')) {
                        btn.classList.remove('status-P');
                        btn.classList.add('status-F');
                        btn.textContent = 'F';
                        frequenciaData[aluno.id] = 'F';
                    } else {
                        btn.classList.remove('status-F');
                        btn.classList.add('status-P');
                        btn.textContent = 'P';
                        frequenciaData[aluno.id] = 'P';
                    }
                });

                tbody.appendChild(tr);
            });
        }

        async function saveFrequency() {
            const salaId = document.getElementById('select-sala-registro').value;
            const data = document.getElementById('input-data-registro').value;
            if (!salaId || !data) return mostrarMsg('Selecione Sala e Data.', 'danger');

            // Busca informa√ß√µes da sala e alunos
            const sala = salasData.find(s => s.id == salaId);
            if (!sala) return mostrarMsg('Sala n√£o encontrada.', 'danger');

            const registros = await Promise.all(
                Object.entries(frequenciaData).map(async ([aluno_id, status]) => {
                    const aluno = alunosData.find(a => a.id == aluno_id);
                    return {
                        aluno_nome: aluno.aluno_nome,
                        sala_nome: sala.nome,
                        data: data,
                        status: status,
                        created_at: new Date(),
                        updated_at: new Date()
                    };
                })
            );

            if (!registros.length) return mostrarMsg('Nenhum registro encontrado.', 'danger');

            mostrarMsg('Salvando...', 'secondary-accent');

            try {
                const result = await salvarFrequenciaSupabase(registros);
                if (result.success) {
                    mostrarMsg(result.message, 'accent');
                    checkFrequencyStatus();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                mostrarMsg('Erro ao salvar: ' + error.message, 'danger');
            }
        }

        // ========== M√ìDULO ATRASO ==========
        function configurarModuloAtraso() {
            const selectSala = document.getElementById('sala-atraso');
            const selectAluno = document.getElementById('aluno-atraso');
            const btnSalvar = document.getElementById('btnSalvarAtraso');
            
            if (selectSala) {
                selectSala.addEventListener('change', () => carregarAlunosAtraso());
            }
            
            if (btnSalvar) {
                btnSalvar.addEventListener('click', salvarAtraso);
            }
        }

        async function carregarAlunosAtraso() {
            const salaId = document.getElementById('sala-atraso').value;
            const sel = document.getElementById('aluno-atraso');
            sel.innerHTML = '<option value="">Selecione o Aluno</option>';
            if (!salaId) return;
            
            try {
                const alunos = await carregarAlunosPorSala(salaId);
                alunos.forEach(a => sel.innerHTML += `<option value="${a.id}">${a.aluno_nome}</option>`);
            } catch (e) {
                console.error(e);
                mostrarMsg('Erro ao carregar alunos', 'danger');
            }
        }

        async function salvarAtraso() {
            const aluno_id = document.getElementById('aluno-atraso').value;
            const sala_id = document.getElementById('sala-atraso').value;
            const data = document.getElementById('data-atraso').value;
            const hora_atraso = document.getElementById('hora-atraso').value;
            const motivo_atraso = document.getElementById('motivo-atraso').value;
            const responsavel_atraso = document.getElementById('responsavel-atraso').value;
            const telefone_atraso = document.getElementById('telefone-atraso').value;

            if (!aluno_id || !sala_id || !data || !hora_atraso || !motivo_atraso || !responsavel_atraso || !telefone_atraso) {
                mostrarMsg('Preencha todos os campos', 'danger');
                return;
            }

            const payload = {
                aluno_id: Number(aluno_id),
                sala_id: Number(sala_id),
                data: data,
                hora_entrada: hora_atraso,
                motivo_atraso: motivo_atraso,
                responsavel_nome: responsavel_atraso,
                responsavel_telefone: telefone_atraso
            };

            mostrarMsg('Enviando...', 'secondary-accent');

            try {
                const result = await salvarAtrasoSupabase(payload);
                if (result.success) {
                    mostrarMsg(result.message, 'accent');
                    document.getElementById('form-atraso').reset();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                mostrarMsg('Erro ao salvar atraso: ' + error.message, 'danger');
            }
        }

        // ========== M√ìDULO SA√çDA ANTECIPADA ==========
        function configurarModuloSaida() {
            const selectSala = document.getElementById('sala-saida');
            const selectAluno = document.getElementById('aluno-saida');
            const btnSalvar = document.getElementById('btnSalvarSaida');
            
            if (selectSala) {
                selectSala.addEventListener('change', () => carregarAlunosSaida());
            }
            
            if (btnSalvar) {
                btnSalvar.addEventListener('click', salvarSaida);
            }
        }

        async function carregarAlunosSaida() {
            const salaId = document.getElementById('sala-saida').value;
            const sel = document.getElementById('aluno-saida');
            sel.innerHTML = '<option value="">Selecione o Aluno</option>';
            if (!salaId) return;
            
            try {
                const alunos = await carregarAlunosPorSala(salaId);
                alunos.forEach(a => sel.innerHTML += `<option value="${a.id}">${a.aluno_nome}</option>`);
            } catch (e) {
                console.error(e);
                mostrarMsg('Erro ao carregar alunos', 'danger');
            }
        }

        async function salvarSaida() {
            const aluno_id = document.getElementById('aluno-saida').value;
            const sala_id = document.getElementById('sala-saida').value;
            const data = document.getElementById('data-saida').value;
            const hora_saida = document.getElementById('hora-saida').value;
            const motivo_saida = document.getElementById('motivo-saida').value;
            const responsavel_saida = document.getElementById('responsavel-saida').value;
            const telefone_saida = document.getElementById('telefone-saida').value;

            if (!aluno_id || !sala_id || !data || !hora_saida || !motivo_saida || !responsavel_saida || !telefone_saida) {
                mostrarMsg('Preencha todos os campos', 'danger');
                return;
            }

            const payload = {
                aluno_id: Number(aluno_id),
                sala_id: Number(sala_id),
                data: data,
                hora_saida: hora_saida,
                motivo_saida: motivo_saida,
                responsavel_nome: responsavel_saida,
                responsavel_telefone: telefone_saida
            };

            mostrarMsg('Enviando...', 'secondary-accent');

            try {
                const result = await salvarSaidaSupabase(payload);
                if (result.success) {
                    mostrarMsg(result.message, 'accent');
                    document.getElementById('form-saida').reset();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                mostrarMsg('Erro ao salvar sa√≠da antecipada: ' + error.message, 'danger');
            }
        }

        // ========== M√ìDULO RELAT√ìRIO ==========
        function configurarModuloRelatorio() {
            const btnVisualizar = document.getElementById('btnVisualizarRelatorio');
            const btnGerarPDF = document.getElementById('btnGerarPDFRelatorio');
            
            if (btnVisualizar) {
                btnVisualizar.addEventListener('click', visualizarRelatorio);
            }
            
            if (btnGerarPDF) {
                btnGerarPDF.addEventListener('click', gerarPDFRelatorio);
            }
        }

        function carregarMesesRelatorio() {
            const meses = [
                "Janeiro","Fevereiro","Mar√ßo","Abril","Maio","Junho",
                "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
            ];
            const sel = document.getElementById('mesSelectRelatorio');
            sel.innerHTML = '<option value="">Selecione o M√™s</option>';
            meses.forEach((m,i) => {
                sel.innerHTML += `<option value="${i+1}">${m}</option>`;
            });
        }

        async function visualizarRelatorio() {
            const sala = document.getElementById('salaSelectRelatorio').value;
            const mes = document.getElementById('mesSelectRelatorio').value;
            if (!sala || !mes) {
                mostrarMsg('Selecione a sala e o m√™s.', 'danger');
                return;
            }
            try {
                dadosFrequencia = await carregarRelatorioMensal(sala, mes);
                montarTabelaRelatorio(dadosFrequencia, parseInt(mes));
            } catch (e) {
                console.error(e);
                mostrarMsg('Erro ao carregar relat√≥rio.', 'danger');
            }
        }

        function montarTabelaRelatorio(dados, mes) {
            const container = document.getElementById("tabelaContainerRelatorio");
            container.innerHTML = "";
            const ano = new Date().getFullYear();
            const dias = [];
            const totalDias = new Date(ano, mes, 0).getDate();

            for (let d = 1; d <= totalDias; d++) {
                const data = dayjs(`${ano}-${String(mes).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
                const diaSemana = data.day();
                if (diaSemana !== 0 && diaSemana !== 6) dias.push(data);
            }

            const alunos = Array.isArray(dados) && dados.length ? dados : [];

            let html = `
                <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-700 text-sm text-center rounded-lg overflow-hidden">
                    <thead class="bg-dark-primary">
                    <tr>
                        <th class="px-2 py-2 border border-gray-700 text-gray-300">Aluno</th>`;
            dias.forEach(d => {
                // Verificar se √© feriado (15/10 ou 27/10)
                const isFeriado = (d.month() === 9 && d.date() === 15) || (d.month() === 9 && d.date() === 27);
                const feriadoClass = isFeriado ? 'bg-red-500 text-white' : '';
                
                html += `<th class="px-2 py-2 border border-gray-700 text-gray-400 ${feriadoClass}">${d.format("DD")}</th>`;
            });
            html += `</tr></thead><tbody>`;

            if (alunos.length === 0) {
                html += `<tr><td colspan="${dias.length + 1}" class="text-gray-400 py-4">Nenhum registro encontrado.</td></tr>`;
            } else {
                alunos.forEach(aluno => {
                    html += `<tr><td class="border border-gray-700 text-left px-2">${aluno.nome}</td>`;
                    dias.forEach(d => {
                        const dataKey = d.format("YYYY-MM-DD");
                        const freq = aluno.frequencia?.[dataKey] || {};
                        const status = freq.status || "";
                        
                        // Verificar se √© feriado (15/10 ou 27/10)
                        const isFeriado = (d.month() === 9 && d.date() === 15) || (d.month() === 9 && d.date() === 27);
                        
                        let cor = "text-gray-500 cursor-default";
                        let clickHandler = "";
                        let feriadoStyle = "";
                        
                        if (isFeriado) {
                            cor = "bg-red-500 text-white cursor-default";
                            html += `<td class="border border-gray-700 ${cor}" title="Feriado"></td>`;
                        } else {
                            if (status === "P") {
                                cor = "text-green-500 font-bold cursor-default";
                            } else if (status === "F") {
                                cor = "text-red-500 font-bold cursor-default";
                            } else if (["PA", "PS", "PSA"].includes(status)) {
                                cor = "text-yellow-400 font-bold cursor-pointer hover:bg-yellow-400 hover:text-gray-900";
                                clickHandler = `onclick="mostrarDetalhesFrequencia(${aluno.id}, '${dataKey}')"`;
                            }
                            
                            html += `<td class="border border-gray-700 ${cor}" ${clickHandler}>${status}</td>`;
                        }
                    });
                    html += `</tr>`;
                });
            }

            html += `</tbody></table>
                <div class="mt-4 text-gray-400 text-sm text-left">
                <p><span class="text-green-500 font-bold">P</span> = Presen√ßa |
                    <span class="text-red-500 font-bold">F</span> = Ausente |
                    <span class="text-yellow-400 font-bold cursor-pointer" onclick="mostrarLegenda()">PA, PS, PSA</span> = Clique para ver detalhes |
                    <span class="bg-red-500 text-white px-2 py-1 rounded">15/10, 27/10</span> = Feriado
                </p>
                </div>
            </div>`;

            container.innerHTML = html;
        }

        async function mostrarDetalhesFrequencia(alunoId, data) {
            try {
                const detalhes = await carregarDetalhesFrequencia(alunoId, data);
                
                const aluno = dadosFrequencia.find(a => a.id === alunoId);
                const alunoNome = aluno ? aluno.nome : 'Aluno';
                
                let modalContent = `
                <div class="mb-4">
                    <h3 class="text-lg font-bold text-accent">Detalhes da Frequ√™ncia</h3>
                    <p class="text-sm text-gray-300">${alunoNome} - ${dayjs(data).format('DD/MM/YYYY')}</p>
                </div>
                `;
                
                if (detalhes.hora_entrada || detalhes.motivo_atraso) {
                    modalContent += `
                    <div class="mb-4 p-3 bg-yellow-900 rounded-lg">
                        <h4 class="font-bold text-yellow-400">Entrada com Atraso</h4>
                        <p class="text-sm"><strong>Hora:</strong> ${detalhes.hora_entrada || 'N/A'}</p>
                        <p class="text-sm"><strong>Motivo:</strong> ${detalhes.motivo_atraso || 'N/A'}</p>
                    </div>
                    `;
                }
                
                if (detalhes.hora_saida || detalhes.motivo_saida) {
                    modalContent += `
                    <div class="mb-4 p-3 bg-yellow-900 rounded-lg">
                        <h4 class="font-bold text-yellow-400">Sa√≠da Antecipada</h4>
                        <p class="text-sm"><strong>Hora:</strong> ${detalhes.hora_saida || 'N/A'}</p>
                        <p class="text-sm"><strong>Motivo:</strong> ${detalhes.motivo_saida || 'N/A'}</p>
                    </div>
                    `;
                }
                
                if (detalhes.responsavel_nome) {
                    modalContent += `
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg">
                        <h4 class="font-bold text-gray-300">Respons√°vel</h4>
                        <p class="text-sm"><strong>Nome:</strong> ${detalhes.responsavel_nome}</p>
                        <p class="text-sm"><strong>Telefone:</strong> ${detalhes.responsavel_telefone || 'N/A'}</p>
                    </div>
                    `;
                }
                
                if (!detalhes.hora_entrada && !detalhes.hora_saida) {
                    modalContent += `<p class="text-gray-400 text-center">Nenhum detalhe adicional dispon√≠vel.</p>`;
                }
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                <div class="bg-dark-secondary p-6 rounded-lg max-w-md w-full mx-4">
                    ${modalContent}
                    <div class="text-center mt-4">
                    <button onclick="this.closest('.fixed').remove()" 
                        class="px-4 py-2 bg-accent hover:bg-green-600 rounded-lg text-white">
                        Fechar
                    </button>
                    </div>
                </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (e) {
                console.error(e);
                mostrarMsg("Erro ao carregar detalhes da frequ√™ncia.", 'danger');
            }
        }

        function mostrarLegenda() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-dark-secondary p-6 rounded-lg max-w-md w-full mx-4">
                <h3 class="text-lg font-bold text-accent mb-4">Legenda de Status</h3>
                <div class="space-y-2 text-sm">
                    <p><span class="text-green-500 font-bold">P</span> = Presen√ßa</p>
                    <p><span class="text-red-500 font-bold">F</span> = Falta</p>
                    <p><span class="text-yellow-400 font-bold">PA</span> = Presen√ßa com Atraso</p>
                    <p><span class="text-yellow-400 font-bold">PS</span> = Presen√ßa com Sa√≠da Antecipada</p>
                    <p><span class="text-yellow-400 font-bold">PSA</span> = Presen√ßa com Atraso e Sa√≠da Antecipada</p>
                    <p><span class="bg-red-500 text-white px-2 py-1 rounded">15/10, 27/10</span> = Feriado</p>
                </div>
                <div class="text-center mt-4">
                    <button onclick="this.closest('.fixed').remove()" 
                    class="px-4 py-2 bg-accent hover:bg-green-600 rounded-lg text-white">
                    Fechar
                    </button>
                </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function gerarPDFRelatorio() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({
                orientation: "landscape",
                unit: "pt",
                format: "a4"
            });

            const salaSelect = document.getElementById('salaSelectRelatorio');
            const mesSelect = document.getElementById('mesSelectRelatorio');
            const salaNome = salaSelect.options[salaSelect.selectedIndex]?.text || "Sala n√£o selecionada";
            const mesNome = mesSelect.options[mesSelect.selectedIndex]?.text || "M√™s n√£o selecionado";
            const ano = new Date().getFullYear();

            doc.setFont("helvetica", "bold");
            doc.setFontSize(16);
            doc.text("RELAT√ìRIO DE FREQU√äNCIA", doc.internal.pageSize.getWidth() / 2, 40, { align: "center" });

            doc.setFont("helvetica", "normal");
            doc.setFontSize(12);
            doc.text(`Sala: ${salaNome} ‚Äî M√™s: ${mesNome} / ${ano}`, doc.internal.pageSize.getWidth() / 2, 60, { align: "center" });

            await doc.html(document.getElementById("tabelaContainerRelatorio"), {
                x: 20,
                y: 80,
                html2canvas: {
                scale: 0.6,
                scrollX: 0,
                scrollY: 0,
                windowWidth: document.getElementById("tabelaContainerRelatorio").scrollWidth,
                },
                callback: function (pdf) {
                pdf.save(`relatorio_frequencia_${salaNome}_${mesNome}_${ano}.pdf`);
                },
            });
        }

        // Inicializar meses do relat√≥rio quando o m√≥dulo for carregado
        document.addEventListener('DOMContentLoaded', () => {
            carregarMesesRelatorio();
        });
    </script>
    <style>
        .status-btn {
            @apply px-3 py-2 rounded-lg text-white font-bold transition duration-200;
            width: 45px;
            text-align: center;
            cursor: pointer;
            user-select: none;
        }
        .status-P { background-color: #10B981; }
        .status-F { background-color: #DC2626; }
        .status-P:hover { background-color: #059669; }
        .status-F:hover { background-color: #B91C1C; }
    </style>
</head>
<body class="bg-dark-primary text-text-light min-h-screen">
    <div id="global-message" style="display: none;"></div>
    
    <div class="container mx-auto p-4">
        <header class="text-center mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-secondary-accent mb-2">SISTEMA DE GEST√ÉO DE CONVIV√äNCIA ESCOLAR</h1>
            <h2 class="text-xl sm:text-2xl text-text-light font-light border-b border-gray-700 pb-2 inline-block">M√ìDULO DE GEST√ÉO DE FREQU√äNCIA</h2>
            <div class="mt-4 flex flex-wrap justify-center gap-4">
                <button onclick="window.location.href='/'" class="border border-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-gray-300 transition">Voltar ao Menu Principal</button>
            </div>
        </header>

        <!-- Menu de Navega√ß√£o -->
        <div class="bg-dark-secondary p-6 rounded-lg shadow-lg mb-6">
            <h3 class="text-lg font-semibold mb-4 text-accent">Navega√ß√£o</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <button onclick="mostrarModulo('registro')" class="nav-btn bg-accent text-white px-4 py-3 rounded-lg font-semibold transition">
                    Registro de Frequ√™ncia
                </button>
                <button onclick="mostrarModulo('atraso')" class="nav-btn bg-gray-700 text-gray-300 px-4 py-3 rounded-lg font-semibold transition hover:bg-gray-600">
                    Registro de Atraso
                </button>
                <button onclick="mostrarModulo('saida')" class="nav-btn bg-gray-700 text-gray-300 px-4 py-3 rounded-lg font-semibold transition hover:bg-gray-600">
                    Sa√≠da Antecipada
                </button>
                <button onclick="mostrarModulo('relatorio')" class="nav-btn bg-gray-700 text-gray-300 px-4 py-3 rounded-lg font-semibold transition hover:bg-gray-600">
                    Relat√≥rio Mensal
                </button>
            </div>
        </div>

        <!-- √Årea de Conte√∫do dos M√≥dulos -->
        <div id="area-conteudo">
            
            <!-- M√≥dulo Menu Principal -->
            <div id="modulo-menu" class="bg-dark-secondary rounded-lg shadow-lg p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full">
                    <button onclick="mostrarModulo('registro')" 
                            class="flex flex-col items-center justify-center p-6 text-2xl font-bold bg-accent hover:bg-emerald-600 transition duration-200 ease-in-out rounded-lg shadow-xl transform hover:scale-[1.03] text-white">
                        <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2l4-4m5.618-4.016A11.955 11.955 0 0112 2.944c-.754 0-1.487.124-2.17.359L5.344 5.344A9.998 9.998 0 003 12a9.997 9.997 0 001.344 4.656l.044.072A11.95 11.95 0 0112 21.056c.754 0 1.487-.124 2.17-.359l4.486-1.547a9.998 9.998 0 001.002-3.136c.266-1.12.39-2.288.39-3.468c0-2.316-.628-4.512-1.8-6.438z"></path></svg>
                        REGISTRO DE FREQU√äNCIA
                        <span class="text-sm font-light opacity-80 mt-1">(Presen√ßa/Falta)</span>
                    </button>
                    
                    <button onclick="mostrarModulo('atraso')" 
                            class="flex flex-col items-center justify-center p-6 text-2xl font-bold bg-warning hover:bg-amber-600 transition duration-200 ease-in-out rounded-lg shadow-xl transform hover:scale-[1.03] text-white">
                        <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0a9 9 0 0118 0z"></path></svg>
                        REGISTRO DE ATRASO
                        <span class="text-sm font-light opacity-80 mt-1">(Chegada Ap√≥s o Hor√°rio)</span>
                    </button>
                    
                    <button onclick="mostrarModulo('saida')" 
                            class="flex flex-col items-center justify-center p-6 text-2xl font-bold bg-danger hover:bg-red-700 transition duration-200 ease-in-out rounded-lg shadow-xl transform hover:scale-[1.03] text-white">
                        <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        SA√çDA ANTECIPADA
                        <span class="text-sm font-light opacity-80 mt-1">(Sa√≠da Durante o Per√≠odo)</span>
                    </button>

                    <button onclick="mostrarModulo('relatorio')" 
                            class="report-button flex flex-col items-center justify-center p-6 bg-indigo-600 text-white rounded-xl shadow-md border-0 hover:bg-indigo-700 transition duration-300 ease-in-out col-span-3">
                        <span class="text-4xl mb-2">üìä</span>
                        <span class="text-xl font-bold text-center">RELAT√ìRIO DE FREQU√äNCIA</span>
                        <span class="text-sm opacity-80 mt-1 text-center">(Dados de presen√ßa e faltas)</span>
                    </button>
                </div>
            </div>

            <!-- M√≥dulo Registro de Frequ√™ncia -->
            <div id="modulo-registro" class="hidden bg-dark-secondary rounded-lg shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-6 text-accent">REGISTRO DE FREQU√äNCIA</h3>
                
                <div class="bg-dark-primary p-6 rounded-xl space-y-6 mb-6">
                    <h4 class="text-xl font-bold border-b border-gray-600 pb-3 text-secondary-accent">FILTROS</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="select-sala-registro" class="block text-sm font-medium text-gray-300 mb-1">Sala:</label>
                            <select id="select-sala-registro" class="select-sala w-full p-3 bg-gray-800 rounded border border-gray-700 text-white" required></select>
                        </div>
                        <div>
                            <label for="input-data-registro" class="block text-sm font-medium text-gray-300 mb-1">Data:</label>
                            <input id="input-data-registro" type="date" class="w-full p-3 bg-gray-800 rounded border border-gray-700 text-white" required>
                        </div>
                    </div>
                    <div id="registro-status" class="pt-2 text-center text-lg"></div>
                </div>

                <div id="alunos-list-container" class="bg-dark-primary p-6 rounded-xl hidden transition-all duration-300">
                    <h4 class="text-xl font-bold border-b border-gray-600 pb-3 text-secondary-accent">LISTA DE ALUNOS</h4>
                    <table class="w-full mt-4 border-collapse">
                        <thead class="text-left text-sm text-gray-400 border-b border-gray-700">
                            <tr>
                                <th class="p-3">Aluno</th>
                                <th class="p-3 text-center">Presen√ßa / Falta</th>
                            </tr>
                        </thead>
                        <tbody id="alunos-list-body"></tbody>
                    </table>
                    <button id="btn-salvar-frequencia" class="mt-6 bg-accent hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg w-full hidden">
                        Salvar Frequ√™ncia
                    </button>
                </div>

                <div id="mensagem-travada" class="hidden bg-dark-primary p-6 mt-6 rounded-xl text-center border border-gray-600">
                    <h2 class="text-2xl font-extrabold text-accent mb-4">FREQU√äNCIA J√Å REGISTRADA</h2>
                    <p class="text-lg leading-relaxed text-gray-200">
                        A frequ√™ncia desta <span class="text-secondary-accent font-bold">sala</span> e desta <span class="text-secondary-accent font-bold">data</span>
                        j√° foi registrada anteriormente.<br><br>
                        Para realizar qualquer altera√ß√£o, utilize as telas:
                        <br>
                        <span class="text-accent font-semibold">Registro de Atraso</span> ou
                        <span class="text-accent font-semibold">Sa√≠da Antecipada</span>.
                    </p>
                </div>
            </div>

            <!-- M√≥dulo Registro de Atraso -->
            <div id="modulo-atraso" class="hidden bg-dark-secondary rounded-lg shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-6 text-accent">REGISTRO DE ATRASO</h3>
                
                <form id="form-atraso" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Sala</label>
                            <select id="sala-atraso" class="select-sala w-full p-3 bg-gray-800 rounded border border-gray-700"></select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Aluno</label>
                            <select id="aluno-atraso" class="w-full p-3 bg-gray-800 rounded border border-gray-700"></select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Data</label>
                            <input id="data-atraso" type="date" class="w-full p-3 bg-gray-800 rounded border border-gray-700" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Hora do Atraso</label>
                            <input id="hora-atraso" type="time" class="w-full p-3 bg-gray-800 rounded border border-gray-700" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-300 mb-1">Motivo</label>
                        <textarea id="motivo-atraso" rows="2" class="w-full p-3 bg-gray-800 rounded border border-gray-700" placeholder="Descreva o motivo do atraso..."></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Respons√°vel</label>
                            <input id="responsavel-atraso" type="text" class="w-full p-3 bg-gray-800 rounded border border-gray-700" placeholder="Nome do respons√°vel pelo aluno" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Telefone</label>
                            <input id="telefone-atraso" type="tel" class="w-full p-3 bg-gray-800 rounded border border-gray-700" placeholder="(11) 99999-9999" />
                        </div>
                    </div>

                    <button type="button" id="btnSalvarAtraso" class="mt-4 px-4 py-2 rounded-lg bg-accent hover:bg-green-600 text-white font-semibold transition">
                        Salvar Atraso
                    </button>
                </form>
            </div>

            <!-- M√≥dulo Sa√≠da Antecipada -->
            <div id="modulo-saida" class="hidden bg-dark-secondary rounded-lg shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-6 text-accent">SA√çDA ANTECIPADA</h3>
                
                <form id="form-saida" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Sala</label>
                            <select id="sala-saida" class="select-sala w-full p-3 bg-gray-800 rounded border border-gray-700"></select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Aluno</label>
                            <select id="aluno-saida" class="w-full p-3 bg-gray-800 rounded border border-gray-700"></select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Data</label>
                            <input id="data-saida" type="date" class="w-full p-3 bg-gray-800 rounded border border-gray-700" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Hora da Sa√≠da</label>
                            <input id="hora-saida" type="time" class="w-full p-3 bg-gray-800 rounded border border-gray-700" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-300 mb-1">Motivo</label>
                        <textarea id="motivo-saida" rows="2" class="w-full p-3 bg-gray-800 rounded border border-gray-700" placeholder="Motivo da sa√≠da antecipada..."></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Respons√°vel</label>
                            <input id="responsavel-saida" type="text" class="w-full p-3 bg-gray-800 rounded border border-gray-700" placeholder="Nome do respons√°vel" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Telefone</label>
                            <input id="telefone-saida" type="tel" class="w-full p-3 bg-gray-800 rounded border border-gray-700" placeholder="(11) 99999-9999" />
                        </div>
                    </div>

                    <button type="button" id="btnSalvarSaida" class="mt-4 px-4 py-2 rounded-lg bg-accent hover:bg-green-600 text-white font-semibold transition">
                        Salvar Sa√≠da Antecipada
                    </button>
                </form>
            </div>

            <!-- M√≥dulo Relat√≥rio Mensal -->
            <div id="modulo-relatorio" class="hidden bg-dark-secondary rounded-lg shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-6 text-accent">RELAT√ìRIO MENSAL DE FREQU√äNCIA</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Sala</label>
                        <select id="salaSelectRelatorio" class="select-sala w-full p-3 bg-gray-800 rounded border border-gray-700"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">M√™s</label>
                        <select id="mesSelectRelatorio" class="w-full p-3 bg-gray-800 rounded border border-gray-700"></select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnVisualizarRelatorio" class="w-full bg-accent hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                            Visualizar Frequ√™ncia
                        </button>
                    </div>
                </div>

                <div class="flex justify-end mb-4">
                    <button id="btnGerarPDFRelatorio" class="px-4 py-2 text-sm rounded-lg bg-accent hover:bg-green-600 text-white flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Gerar PDF
                    </button>
                </div>

                <div id="tabelaContainerRelatorio" class="overflow-x-auto text-center text-gray-400">
                    Selecione a sala e o m√™s para visualizar a frequ√™ncia.
                </div>
            </div>

        </div>

        <footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
            <p class="mb-1 text-base font-medium">DESENVOLVEDOR: MARCELO ANDR√â NOGUEIRA CARDES</p>
            <p class="text-xs font-light tracking-wide">LICENCIADO: E.E. PEI PROFESSORA IRENE DIAS RIBEIRO</p>
        </footer>
    </div>
</body>
</html>
