<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestão de Frequência</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'dark-primary': '#0F172A',
                        'dark-secondary': '#1E293B',
                        'accent': '#10B981',
                        'text-light': '#F8FAFC',
                        'danger': '#DC2626',
                        'warning': '#FACC15',
                        'secondary-accent': '#3B82F6',
                        'alert-warning': '#F59E0B',
                        'alert-danger': '#DC2626'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                },
            },
        };

        let moduloAtual = 'menu';
        let dadosFrequencia = [];
        let salasData = [];
        let alunosData = [];
        let frequenciaData = {};
        let isLocked = false;

        document.addEventListener('DOMContentLoaded', function() {
            // Carregar salas primeiro
            carregarSalas().then(() => {
                mostrarModulo('menu');
                
                // Configurar event listeners para os módulos
                configurarModuloRegistro();
                configurarModuloAtraso();
                configurarModuloSaida();
                configurarModuloRelatorio();
                carregarMesesRelatorio();
            }).catch(error => {
                console.error('Erro na inicialização:', error);
                mostrarMsg('Erro ao carregar dados iniciais', 'danger');
                // Mostrar menu mesmo com erro
                mostrarModulo('menu');
            });
        });

        function mostrarModulo(modulo) {
            moduloAtual = modulo;
            
            // Esconder todos os módulos
            document.querySelectorAll('[id^="modulo-"]').forEach(el => {
                el.classList.add('hidden');
            });
            
            // Mostrar módulo selecionado
            const moduloElement = document.getElementById(`modulo-${modulo}`);
            if (moduloElement) {
                moduloElement.classList.remove('hidden');
            }
            
            // Atualizar botões de navegação
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-accent', 'text-white');
                btn.classList.add('bg-gray-700', 'text-gray-300');
            });
            
            const btnAtivo = document.querySelector(`[onclick="mostrarModulo('${modulo}')"]`);
            if (btnAtivo) {
                btnAtivo.classList.add('bg-accent', 'text-white');
                btnAtivo.classList.remove('bg-gray-700', 'text-gray-300');
            }
        }

        function mostrarMsg(msg, tipo = 'info') {
            const el = document.getElementById('global-message');
            if (!el) return;
            
            el.textContent = msg;
            el.className = 'p-3 rounded mt-4 text-white font-bold fixed top-4 right-4 z-50 max-w-sm';
            el.style.display = 'block';
            el.classList.remove('bg-danger', 'bg-accent', 'bg-secondary-accent', 'bg-warning');
            
            if (tipo === 'danger') el.classList.add('bg-danger');
            else if (tipo === 'accent') el.classList.add('bg-accent');
            else if (tipo === 'warning') el.classList.add('bg-warning');
            else el.classList.add('bg-secondary-accent');
            
            setTimeout(() => el.style.display = 'none', 5000);
        }

        async function safeFetch(url, options = {}) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`Erro HTTP: ${response.status}`);
                const data = await response.json();
                return data.data || data;
            } catch (error) {
                console.error('Erro no fetch:', error);
                throw error;
            }
        }

        async function carregarSalas() {
            try {
                console.log('Carregando salas...');
                salasData = await safeFetch('/api/d_salas');
                console.log('Salas carregadas:', salasData);
                
                document.querySelectorAll('.select-sala').forEach(select => {
                    select.innerHTML = '<option value="">Selecione a Sala</option>';
                    salasData.forEach(sala => {
                        const nomeSala = sala.nome || sala.sala || 'Sem nome';
                        select.innerHTML += `<option value="${sala.id}">${nomeSala}</option>`;
                    });
                });
            } catch (e) {
                console.error('Erro ao carregar salas:', e);
                mostrarMsg('Erro ao carregar salas', 'danger');
                // Preencher com dados de fallback para teste
                document.querySelectorAll('.select-sala').forEach(select => {
                    select.innerHTML = '<option value="">Erro ao carregar salas</option>';
                });
            }
        }

        // ========== MÓDULO REGISTRO DE FREQUÊNCIA ==========
        function configurarModuloRegistro() {
            const selectSala = document.getElementById('select-sala-registro');
            const inputData = document.getElementById('input-data-registro');
            
            if (selectSala && inputData) {
                selectSala.addEventListener('change', checkFrequencyStatus);
                inputData.addEventListener('change', checkFrequencyStatus);
            }
            
            const btnSalvar = document.getElementById('btn-salvar-frequencia');
            if (btnSalvar) {
                btnSalvar.addEventListener('click', saveFrequency);
            }
        }

        async function loadAlunosRegistro(sala_id) {
            try {
                console.log('Carregando alunos para sala:', sala_id);
                // Use a API correta para buscar alunos por sala
                const response = await fetch(`/api/alunos_por_sala/${sala_id}`);
                if (!response.ok) throw new Error('Erro ao carregar alunos');
                
                alunosData = await response.json();
                console.log('Alunos carregados:', alunosData);
                renderAlunosList();
            } catch (error) {
                console.error('Erro:', error);
                mostrarMsg('Erro ao carregar alunos.', 'danger');
            }
        }

        async function checkFrequencyStatus() {
            const salaId = document.getElementById('select-sala-registro').value;
            const data = document.getElementById('input-data-registro').value;
            const alunosContainer = document.getElementById('alunos-list-container');
            const statusDiv = document.getElementById('registro-status');
            const mensagemTravada = document.getElementById('mensagem-travada');

            if (!alunosContainer || !statusDiv || !mensagemTravada) return;

            alunosContainer.classList.add('hidden');
            mensagemTravada.classList.add('hidden');
            statusDiv.innerHTML = '';
            
            const btnSalvar = document.getElementById('btn-salvar-frequencia');
            if (btnSalvar) btnSalvar.classList.add('hidden');
            
            frequenciaData = {};
            isLocked = false;

            if (!salaId || !data) return;

            try {
                const statusResponse = await fetch(`/api/frequencia/status?sala_id=${salaId}&data=${data}`);
                const statusData = await statusResponse.json();

                if (statusData.registrada) {
                    statusDiv.innerHTML = `<span class="text-accent font-bold">Frequência já registrada.</span>`;
                    isLocked = true;
                    mensagemTravada.classList.remove('hidden');
                    // Limpar dados locais
                    alunosData = [];
                    frequenciaData = {};
                } else {
                    statusDiv.innerHTML = `<span class="text-secondary-accent font-bold">Frequência pendente.</span>`;
                    alunosContainer.classList.remove('hidden');
                    if (btnSalvar) btnSalvar.classList.remove('hidden');
                    await loadAlunosRegistro(salaId);
                }
            } catch (error) {
                console.error('Erro ao verificar status:', error);
                mostrarMsg('Erro ao verificar status da frequência.', 'danger');
            }
        }

        function renderAlunosList() {
            const tbody = document.getElementById('alunos-list-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';

            alunosData.forEach(aluno => {
                const currentStatus = frequenciaData[aluno.id] || 'P';
                frequenciaData[aluno.id] = currentStatus;
                const colorClass = currentStatus === 'P' ? 'status-P' : 'status-F';

                const tr = document.createElement('tr');
                tr.className = 'border-b border-gray-700 hover:bg-dark-primary transition';
                tr.innerHTML = `
                    <td class="p-3 text-left">${aluno.nome}</td>
                    <td class="p-3 text-center">
                        <div id="btn-${aluno.id}" class="status-btn ${colorClass}">
                            ${currentStatus}
                        </div>
                    </td>
                `;

                tbody.appendChild(tr);

                // Adicionar event listener após o elemento ser inserido no DOM
                setTimeout(() => {
                    const btn = document.getElementById(`btn-${aluno.id}`);
                    if (btn) {
                        btn.addEventListener('click', (e) => {
                            const btn = e.currentTarget;
                            if (btn.classList.contains('status-P')) {
                                btn.classList.remove('status-P');
                                btn.classList.add('status-F');
                                btn.textContent = 'F';
                                frequenciaData[aluno.id] = 'F';
                            } else {
                                btn.classList.remove('status-F');
                                btn.classList.add('status-P');
                                btn.textContent = 'P';
                                frequenciaData[aluno.id] = 'P';
                            }
                        });
                    }
                }, 0);
            });
        }

        async function saveFrequency() {
            const btnSalvar = document.getElementById('btn-salvar-frequencia');
            const salaId = document.getElementById('select-sala-registro').value;
            const data = document.getElementById('input-data-registro').value;
            
            if (!salaId || !data) return mostrarMsg('Selecione Sala e Data.', 'danger');

            // Desabilitar o botão e mostrar estado de carregamento
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = 'Salvando...';
            btnSalvar.classList.remove('bg-accent', 'hover:bg-green-600');
            btnSalvar.classList.add('bg-gray-500', 'cursor-not-allowed');

            // Buscar nome da sala selecionada
            const salaSelect = document.getElementById('select-sala-registro');
            const salaNome = salaSelect.options[salaSelect.selectedIndex].text;

            // Criar array de registros
            const registros = Object.entries(frequenciaData).map(([aluno_id, status]) => {
                const aluno = alunosData.find(a => a.id == aluno_id);
                return {
                    aluno_id: parseInt(aluno_id),
                    aluno_nome: aluno ? aluno.nome : 'Aluno Desconhecido',
                    sala_id: parseInt(salaId),
                    sala_nome: salaNome,
                    data: data,
                    status: status
                };
            });

            if (!registros.length) {
                mostrarMsg('Nenhum registro encontrado.', 'danger');
                // Reabilitar botão em caso de erro
                resetButton(btnSalvar);
                return;
            }

            mostrarMsg('Salvando...', 'secondary-accent');

            try {
                const response = await fetch('/api/salvar_frequencia_unificada', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(registros)
                });
                
                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Erro ao salvar');
                
                mostrarMsg('Frequência salva com sucesso!', 'accent');
                checkFrequencyStatus(); // Recarregar status
                
            } catch (error) {
                console.error('Erro:', error);
                mostrarMsg(error.message || 'Erro ao salvar frequência', 'danger');
            } finally {
                // Sempre redefinir o botão, independente de sucesso ou erro
                resetButton(btnSalvar);
            }
        }

        function resetButton(button) {
            button.disabled = false;
            button.innerHTML = 'Salvar Frequência';
            button.classList.remove('bg-gray-500', 'cursor-not-allowed');
            button.classList.add('bg-accent', 'hover:bg-green-600');
        }

        // ========== MÓDULO ATRASO ==========
        function configurarModuloAtraso() {
            const selectSala = document.getElementById('sala-atraso');
            const btnSalvar = document.getElementById('btnSalvarAtraso');
            
            if (selectSala) {
                selectSala.addEventListener('change', carregarAlunosAtraso);
            }
            
            if (btnSalvar) {
                btnSalvar.addEventListener('click', salvarAtraso);
            }
        }

        async function carregarAlunosAtraso() {
            const salaId = document.getElementById('sala-atraso').value;
            const sel = document.getElementById('aluno-atraso');
            if (!sel) return;
            
            sel.innerHTML = '<option value="">Selecione o Aluno</option>';
            if (!salaId) return;
            
            try {
                const r = await fetch(`/api/alunos_por_sala/${salaId}`);
                if (!r.ok) throw new Error('Erro ao buscar alunos');
                const alunos = await r.json();
                alunos.forEach(a => sel.innerHTML += `<option value="${a.id}">${a.nome}</option>`);
            } catch (e) {
                console.error(e);
                mostrarMsg('Erro ao carregar alunos', 'danger');
            }
        }

        async function salvarAtraso() {
            const btnSalvar = document.getElementById('btnSalvarAtraso');
            const aluno_id = document.getElementById('aluno-atraso').value;
            const sala_id = document.getElementById('sala-atraso').value;
            const data = document.getElementById('data-atraso').value;
            const hora_entrada = document.getElementById('hora-atraso').value;
            const motivo_atraso = document.getElementById('motivo-atraso').value;
            const responsavel_atraso = document.getElementById('responsavel-atraso').value;
            const telefone_atraso = document.getElementById('telefone-atraso').value;

            if (!aluno_id || !sala_id || !data || !hora_entrada || !motivo_atraso || !responsavel_atraso || !telefone_atraso) {
                mostrarMsg('Preencha todos os campos', 'danger');
                return;
            }

            // Desabilitar botão
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = 'Salvando...';
            btnSalvar.classList.remove('bg-accent', 'hover:bg-green-600');
            btnSalvar.classList.add('bg-gray-500', 'cursor-not-allowed');

            // Buscar nomes do aluno e sala
            const alunoSelect = document.getElementById('aluno-atraso');
            const alunoNome = alunoSelect.options[alunoSelect.selectedIndex].text;
            const salaSelect = document.getElementById('sala-atraso');
            const salaNome = salaSelect.options[salaSelect.selectedIndex].text;

            const payload = {
                aluno_id: parseInt(aluno_id),
                aluno_nome: alunoNome,
                sala_id: parseInt(sala_id),
                sala_nome: salaNome,
                data: data,
                hora_entrada: hora_entrada,
                motivo_atraso: motivo_atraso,
                responsavel_nome: responsavel_atraso,
                responsavel_telefone: telefone_atraso,
                // Forçar status PA (Presença com Atraso)
                status: 'PA'
            };

            mostrarMsg('Salvando atraso...', 'secondary-accent');

            try {
                const resp = await fetch('/api/salvar_frequencia_unificada', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify([payload])
                });

                const result = await resp.json();
                if (resp.ok) {
                    mostrarMsg('Atraso registrado com sucesso!', 'accent');
                    document.getElementById('form-atraso').reset();
                } else {
                    throw new Error(result.error || 'Erro ao salvar atraso');
                }
            } catch (error) {
                console.error('Erro:', error);
                mostrarMsg(error.message, 'danger');
            } finally {
                // Reabilitar botão
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = 'Salvar Atraso';
                btnSalvar.classList.remove('bg-gray-500', 'cursor-not-allowed');
                btnSalvar.classList.add('bg-accent', 'hover:bg-green-600');
            }
        }

        // ========== MÓDULO SAÍDA ANTECIPADA ==========
        function configurarModuloSaida() {
            const selectSala = document.getElementById('sala-saida');
            const btnSalvar = document.getElementById('btnSalvarSaida');
            
            if (selectSala) {
                selectSala.addEventListener('change', carregarAlunosSaida);
            }
            
            if (btnSalvar) {
                btnSalvar.addEventListener('click', salvarSaida);
            }
        }

        async function carregarAlunosSaida() {
            const salaId = document.getElementById('sala-saida').value;
            const sel = document.getElementById('aluno-saida');
            if (!sel) return;
            
            sel.innerHTML = '<option value="">Selecione o Aluno</option>';
            if (!salaId) return;
            
            try {
                const r = await fetch(`/api/alunos_por_sala/${salaId}`);
                if (!r.ok) throw new Error('Erro ao buscar alunos');
                const alunos = await r.json();
                alunos.forEach(a => sel.innerHTML += `<option value="${a.id}">${a.nome}</option>`);
            } catch (e) {
                console.error(e);
                mostrarMsg('Erro ao carregar alunos', 'danger');
            }
        }

        async function salvarSaida() {
            const btnSalvar = document.getElementById('btnSalvarSaida');
            const aluno_id = document.getElementById('aluno-saida').value;
            const sala_id = document.getElementById('sala-saida').value;
            const data = document.getElementById('data-saida').value;
            const hora_saida = document.getElementById('hora-saida').value;
            const motivo_saida = document.getElementById('motivo-saida').value;
            const responsavel_saida = document.getElementById('responsavel-saida').value;
            const telefone_saida = document.getElementById('telefone-saida').value;

            if (!aluno_id || !sala_id || !data || !hora_saida || !motivo_saida || !responsavel_saida || !telefone_saida) {
                mostrarMsg('Preencha todos os campos', 'danger');
                return;
            }

            // Desabilitar botão
            btnSalvar.disabled = true;
            btnSalvar.innerHTML = 'Salvando...';
            btnSalvar.classList.remove('bg-accent', 'hover:bg-green-600');
            btnSalvar.classList.add('bg-gray-500', 'cursor-not-allowed');

            // Buscar nomes do aluno e sala
            const alunoSelect = document.getElementById('aluno-saida');
            const alunoNome = alunoSelect.options[alunoSelect.selectedIndex].text;
            const salaSelect = document.getElementById('sala-saida');
            const salaNome = salaSelect.options[salaSelect.selectedIndex].text;

            const payload = {
                aluno_id: parseInt(aluno_id),
                aluno_nome: alunoNome,
                sala_id: parseInt(sala_id),
                sala_nome: salaNome,
                data: data,
                hora_saida: hora_saida,
                motivo_saida: motivo_saida,
                responsavel_nome: responsavel_saida,
                responsavel_telefone: telefone_saida,
                // Forçar status PS (Presença com Saída Antecipada)
                status: 'PS'
            };

            mostrarMsg('Salvando saída antecipada...', 'secondary-accent');

            try {
                const resp = await fetch('/api/salvar_frequencia_unificada', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify([payload])
                });

                const result = await resp.json();
                if (resp.ok) {
                    mostrarMsg('Saída antecipada registrada com sucesso!', 'accent');
                    document.getElementById('form-saida').reset();
                } else {
                    throw new Error(result.error || 'Erro ao salvar saída antecipada');
                }
            } catch (error) {
                console.error('Erro:', error);
                mostrarMsg(error.message, 'danger');
            } finally {
                // Reabilitar botão
                btnSalvar.disabled = false;
                btnSalvar.innerHTML = 'Salvar Saída Antecipada';
                btnSalvar.classList.remove('bg-gray-500', 'cursor-not-allowed');
                btnSalvar.classList.add('bg-accent', 'hover:bg-green-600');
            }
        }

        // ========== MÓDULO RELATÓRIO ==========
        function configurarModuloRelatorio() {
            const btnVisualizar = document.getElementById('btnVisualizarRelatorio');
            const btnGerarPDF = document.getElementById('btnGerarPDFRelatorio');
            
            if (btnVisualizar) {
                btnVisualizar.addEventListener('click', visualizarRelatorio);
            }
            
            if (btnGerarPDF) {
                btnGerarPDF.addEventListener('click', gerarPDFRelatorio);
            }
        }

        function carregarMesesRelatorio() {
            const meses = [
                "Janeiro","Fevereiro","Março","Abril","Maio","Junho",
                "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
            ];
            const sel = document.getElementById('mesSelectRelatorio');
            if (!sel) return;
            
            sel.innerHTML = '<option value="">Selecione o Mês</option>';
            meses.forEach((m,i) => {
                sel.innerHTML += `<option value="${i+1}">${m}</option>`;
            });
        }

        async function visualizarRelatorio() {
            const sala = document.getElementById('salaSelectRelatorio').value;
            const mes = document.getElementById('mesSelectRelatorio').value;
            if (!sala || !mes) {
                mostrarMsg('Selecione a sala e o mês.', 'danger');
                return;
            }
            try {
                const resp = await fetch(`/api/frequencia?sala=${sala}&mes=${mes}`);
                if (!resp.ok) throw new Error("Erro ao carregar frequência");
                dadosFrequencia = await resp.json();
                montarTabelaRelatorio(dadosFrequencia, parseInt(mes));
            } catch (e) {
                console.error(e);
                mostrarMsg('Erro ao carregar relatório.', 'danger');
            }
        }

        function montarTabelaRelatorio(dados, mes) {
            const container = document.getElementById("tabelaContainerRelatorio");
            if (!container) return;
            
            container.innerHTML = "";
            const ano = new Date().getFullYear();
            const dias = [];
            const totalDias = new Date(ano, mes, 0).getDate();

            for (let d = 1; d <= totalDias; d++) {
                const data = dayjs(`${ano}-${String(mes).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
                const diaSemana = data.day();
                if (diaSemana !== 0 && diaSemana !== 6) dias.push(data);
            }

            const alunos = Array.isArray(dados) && dados.length ? dados : [];

            let html = `
                <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-700 text-sm text-center rounded-lg overflow-hidden">
                    <thead class="bg-dark-primary">
                    <tr>
                        <th class="px-2 py-2 border border-gray-700 text-gray-300">Aluno</th>`;
            dias.forEach(d => {
                html += `<th class="px-2 py-2 border border-gray-700 text-gray-400">${d.format("DD")}</th>`;
            });
            html += `</tr></thead><tbody>`;

            if (alunos.length === 0) {
                html += `<tr><td colspan="${dias.length + 1}" class="text-gray-400 py-4">Nenhum registro encontrado.</td></tr>`;
            } else {
                alunos.forEach(aluno => {
                    html += `<tr><td class="border border-gray-700 text-left px-2">${aluno.nome}</td>`;
                    dias.forEach(d => {
                        const dataKey = d.format("YYYY-MM-DD");
                        const freq = aluno.frequencia?.[dataKey] || {};
                        const status = freq.status || "";
                        
                        let cor = "text-gray-500 cursor-default";
                        let clickHandler = "";
                        
                        if (status === "P") {
                            cor = "text-green-500 font-bold cursor-default";
                        } else if (status === "F") {
                            cor = "text-red-500 font-bold cursor-default";
                        } else if (["PA", "PS", "PSA"].includes(status)) {
                            cor = "text-yellow-400 font-bold cursor-pointer hover:bg-yellow-400 hover:text-gray-900";
                            clickHandler = `onclick="mostrarDetalhesFrequencia(${aluno.id}, '${dataKey}')"`;
                        }
                        
                        html += `<td class="border border-gray-700 ${cor}" ${clickHandler}>${status}</td>`;
                    });
                    html += `</tr>`;
                });
            }

            html += `</tbody></table>
                <div class="mt-4 text-gray-400 text-sm text-left">
                <p><span class="text-green-500 font-bold">P</span> = Presença |
                    <span class="text-red-500 font-bold">F</span> = Ausente |
                    <span class="text-yellow-400 font-bold cursor-pointer" onclick="mostrarLegenda()">PA, PS, PSA</span> = Clique para ver detalhes
                </p>
                </div>
            </div>`;

            container.innerHTML = html;
        }

        async function mostrarDetalhesFrequencia(alunoId, data) {
            try {
                const resp = await fetch(`/api/frequencia_detalhes/${alunoId}/${data}`);
                if (!resp.ok) throw new Error("Erro ao carregar detalhes");
                const detalhes = await resp.json();
                
                const aluno = dadosFrequencia.find(a => a.id === alunoId);
                const alunoNome = aluno ? aluno.nome : 'Aluno';
                
                let modalContent = `
                <div class="mb-4">
                    <h3 class="text-lg font-bold text-accent">Detalhes da Frequência</h3>
                    <p class="text-sm text-gray-300">Aluno: ${alunoNome}</p>
                    <p class="text-sm text-gray-300">Data: ${dayjs(data).format('DD/MM/YYYY')}</p>
                    <p class="text-sm text-gray-300">Status: ${detalhes.status || 'N/A'}</p>
                </div>
                `;
                
                // Determinar quais campos mostrar baseado no status
                const status = detalhes.status;
                
                if (status === 'PA' || status === 'PSA') {
                    // Mostrar dados de atraso
                    modalContent += `
                    <div class="mb-4 p-3 bg-yellow-900 rounded-lg">
                        <h4 class="font-bold text-yellow-400">Entrada com Atraso</h4>
                        <p class="text-sm"><strong>Hora do Atraso:</strong> ${detalhes.hora_entrada || 'N/A'}</p>
                        <p class="text-sm"><strong>Motivo do Atraso:</strong> ${detalhes.motivo_atraso || 'N/A'}</p>
                    </div>
                    `;
                }
                
                if (status === 'PS' || status === 'PSA') {
                    // Mostrar dados de saída antecipada
                    modalContent += `
                    <div class="mb-4 p-3 bg-orange-900 rounded-lg">
                        <h4 class="font-bold text-orange-400">Saída Antecipada</h4>
                        <p class="text-sm"><strong>Hora da Saída:</strong> ${detalhes.hora_saida || 'N/A'}</p>
                        <p class="text-sm"><strong>Motivo da Saída:</strong> ${detalhes.motivo_saida || 'N/A'}</p>
                    </div>
                    `;
                }
                
                // Sempre mostrar dados do responsável se disponíveis
                if (detalhes.responsavel_nome) {
                    modalContent += `
                    <div class="mb-4 p-3 bg-gray-800 rounded-lg">
                        <h4 class="font-bold text-gray-300">Responsável</h4>
                        <p class="text-sm"><strong>Nome:</strong> ${detalhes.responsavel_nome}</p>
                        <p class="text-sm"><strong>Telefone:</strong> ${detalhes.responsavel_telefone || 'N/A'}</p>
                    </div>
                    `;
                }
                
                // Caso não haja nenhum detalhe adicional específico
                if ((status === 'PA' && !detalhes.hora_entrada && !detalhes.motivo_atraso) ||
                    (status === 'PS' && !detalhes.hora_saida && !detalhes.motivo_saida) ||
                    (status === 'PSA' && !detalhes.hora_entrada && !detalhes.motivo_atraso && !detalhes.hora_saida && !detalhes.motivo_saida)) {
                    modalContent += `<p class="text-gray-400 text-center">Nenhum detalhe adicional disponível para este status.</p>`;
                }
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                <div class="bg-dark-secondary p-6 rounded-lg max-w-md w-full mx-4">
                    ${modalContent}
                    <div class="text-center mt-4">
                    <button onclick="this.closest('.fixed').remove()" 
                        class="px-4 py-2 bg-accent hover:bg-green-600 rounded-lg text-white">
                        Fechar
                    </button>
                    </div>
                </div>
                `;
                
                document.body.appendChild(modal);
                
            } catch (e) {
                console.error('Erro ao carregar detalhes:', e);
                
                // Modal de erro mais amigável
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                <div class="bg-dark-secondary p-6 rounded-lg max-w-md w-full mx-4">
                    <div class="mb-4">
                        <h3 class="text-lg font-bold text-red-500">Erro ao Carregar Detalhes</h3>
                        <p class="text-sm text-gray-300 mt-2">Não foi possível conectar ao servidor para obter os detalhes da frequência.</p>
                        <p class="text-sm text-gray-300 mt-1">Verifique sua conexão com a internet e tente novamente.</p>
                    </div>
                    <div class="text-center mt-4">
                        <button onclick="this.closest('.fixed').remove()" 
                            class="px-4 py-2 bg-accent hover:bg-green-600 rounded-lg text-white">
                            Fechar
                        </button>
                    </div>
                </div>
                `;
                
                document.body.appendChild(modal);
            }
        }

        function mostrarLegenda() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-dark-secondary p-6 rounded-lg max-w-md w-full mx-4">
                <h3 class="text-lg font-bold text-accent mb-4">Legenda de Status</h3>
                <div class="space-y-2 text-sm">
                    <p><span class="text-green-500 font-bold">P</span> = Presença</p>
                    <p><span class="text-red-500 font-bold">F</span> = Falta</p>
                    <p><span class="text-yellow-400 font-bold">PA</span> = Presença com Atraso</p>
                    <p><span class="text-yellow-400 font-bold">PS</span> = Presença com Saída Antecipada</p>
                    <p><span class="text-yellow-400 font-bold">PSA</span> = Presença com Atraso e Saída Antecipada</p>
                </div>
                <div class="text-center mt-4">
                    <button onclick="this.closest('.fixed').remove()" 
                    class="px-4 py-2 bg-accent hover:bg-green-600 rounded-lg text-white">
                    Fechar
                    </button>
                </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Função para gerar PDF profissional em formato de planilha
        async function gerarPDFRelatorio() {
            const btnGerarPDF = document.getElementById('btnGerarPDFRelatorio');
            
            try {
                // Desabilitar botão durante a geração
                btnGerarPDF.disabled = true;
                btnGerarPDF.innerHTML = 'Gerando PDF...';
                btnGerarPDF.classList.remove('bg-accent', 'hover:bg-green-600');
                btnGerarPDF.classList.add('bg-gray-500', 'cursor-not-allowed');

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: "landscape",
                    unit: "mm",
                    format: "a4"
                });

                const salaSelect = document.getElementById('salaSelectRelatorio');
                const mesSelect = document.getElementById('mesSelectRelatorio');
                const salaNome = salaSelect.options[salaSelect.selectedIndex]?.text || "Sala não selecionada";
                const mesNome = mesSelect.options[mesSelect.selectedIndex]?.text || "Mês não selecionado";
                const ano = new Date().getFullYear();

                // Configurações para documento de impressão (fundo branco)
                doc.setFillColor(255, 255, 255);
                doc.rect(0, 0, doc.internal.pageSize.getWidth(), doc.internal.pageSize.getHeight(), 'F');

                // Cabeçalho profissional
                doc.setFillColor(15, 23, 42); // dark-primary
                doc.rect(0, 0, doc.internal.pageSize.getWidth(), 20, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFont("helvetica", "bold");
                doc.setFontSize(16);
                doc.text("RELATÓRIO DE FREQUÊNCIA ESCOLAR", doc.internal.pageSize.getWidth() / 2, 12, { align: "center" });

                // Informações
                doc.setFontSize(10);
                doc.text(`Sala: ${salaNome}`, 10, 25);
                doc.text(`Período: ${mesNome}/${ano}`, 10, 31);
                doc.text(`Data de Emissão: ${new Date().toLocaleDateString('pt-BR')}`, doc.internal.pageSize.getWidth() - 10, 25, { align: "right" });
                doc.text(`Escola: E.E. PEI PROFESSORA IRENE DIAS RIBEIRO`, doc.internal.pageSize.getWidth() - 10, 31, { align: "right" });

                // Linha divisória
                doc.setDrawColor(200, 200, 200);
                doc.line(10, 35, doc.internal.pageSize.getWidth() - 10, 35);

                // Verificar se há dados
                const tabelaContainer = document.getElementById("tabelaContainerRelatorio");
                if (!tabelaContainer || tabelaContainer.innerHTML.includes("Nenhum registro") || 
                    tabelaContainer.innerHTML.includes("Selecione a sala")) {
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(14);
                    doc.text("Nenhum dado disponível para o relatório selecionado", doc.internal.pageSize.getWidth() / 2, 80, { align: "center" });
                    doc.save(`relatorio_frequencia_${salaNome.replace(/\s+/g, '_')}_${mesNome}_${ano}.pdf`);
                    mostrarMsg('PDF gerado sem dados.', 'warning');
                    return;
                }

                // Buscar dados diretamente da API para ter controle total
                try {
                    const salaId = salaSelect.value;
                    const mes = mesSelect.value;
                    const response = await fetch(`/api/frequencia?sala=${salaId}&mes=${mes}`);
                    const dados = await response.json();
                    
                    await gerarPlanilhaPDF(doc, dados, parseInt(mes), salaNome, mesNome, ano);
                    
                } catch (error) {
                    console.error('Erro ao buscar dados:', error);
                    // Fallback: usar html2canvas
                    await gerarPDFFallback(doc, salaNome, mesNome, ano);
                }

            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                mostrarMsg('Erro ao gerar PDF. Tente novamente.', 'danger');
            } finally {
                // Reabilitar o botão
                btnGerarPDF.disabled = false;
                btnGerarPDF.innerHTML = 'Gerar PDF';
                btnGerarPDF.classList.remove('bg-gray-500', 'cursor-not-allowed');
                btnGerarPDF.classList.add('bg-accent', 'hover:bg-green-600');
            }
        }

        // Função para gerar PDF em formato de planilha
        async function gerarPlanilhaPDF(doc, dados, mes, salaNome, mesNome, ano) {
            const alunos = Array.isArray(dados) && dados.length ? dados : [];
            const anoAtual = new Date().getFullYear();
            
            // Calcular dias úteis do mês
            const dias = [];
            const totalDias = new Date(anoAtual, mes, 0).getDate();
            for (let d = 1; d <= totalDias; d++) {
                const data = dayjs(`${anoAtual}-${String(mes).padStart(2,'0')}-${String(d).padStart(2,'0')}`);
                const diaSemana = data.day();
                if (diaSemana !== 0 && diaSemana !== 6) {
                    dias.push({
                        data: data,
                        dia: d,
                        diaSemana: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'][diaSemana]
                    });
                }
            }

            // Configurações da planilha
            const startY = 40;
            const lineHeight = 6;
            const colWidth = 7;
            const nomeColWidth = 50;
            let currentY = startY;

            // Cabeçalho da planilha - estilo Excel
            doc.setFillColor(79, 70, 229); // Azul escuro
            doc.rect(10, currentY, doc.internal.pageSize.getWidth() - 20, lineHeight, 'F');
            
            doc.setTextColor(255, 255, 255);
            doc.setFontSize(9);
            doc.setFont("helvetica", "bold");
            
            // Coluna do nome
            doc.text("ALUNO", 12, currentY + 4);
            
            // Colunas dos dias
            dias.forEach((dia, index) => {
                const xPos = 12 + nomeColWidth + (index * colWidth);
                doc.text(dia.dia.toString(), xPos + 1, currentY + 4);
            });

            currentY += lineHeight;

            // Dados dos alunos - estilo planilha
            doc.setTextColor(0, 0, 0);
            doc.setFont("helvetica", "normal");
            doc.setFontSize(8);

            alunos.forEach((aluno, alunoIndex) => {
                // Alternar cores das linhas para melhor legibilidade (estilo Excel)
                if (alunoIndex % 2 === 0) {
                    doc.setFillColor(249, 250, 251); // cinza muito claro
                } else {
                    doc.setFillColor(255, 255, 255); // branco
                }
                doc.rect(10, currentY, doc.internal.pageSize.getWidth() - 20, lineHeight, 'F');

                // Borda da linha
                doc.setDrawColor(209, 213, 219);
                doc.setLineWidth(0.1);
                doc.line(10, currentY, doc.internal.pageSize.getWidth() - 10, currentY);
                doc.line(10, currentY + lineHeight, doc.internal.pageSize.getWidth() - 10, currentY + lineHeight);

                // Nome do aluno (truncar se for muito longo)
                let nomeAluno = aluno.nome;
                if (nomeAluno.length > 30) {
                    nomeAluno = nomeAluno.substring(0, 30) + '...';
                }
                doc.text(nomeAluno, 12, currentY + 4);

                // Status de frequência
                dias.forEach((dia, diaIndex) => {
                    const dataKey = dia.data.format("YYYY-MM-DD");
                    const freq = aluno.frequencia?.[dataKey] || {};
                    const status = freq.status || "";
                    
                    const xPos = 12 + nomeColWidth + (diaIndex * colWidth);
                    
                    // Cores baseadas no status
                    if (status === "P") {
                        doc.setTextColor(16, 185, 129); // verde
                    } else if (status === "F") {
                        doc.setTextColor(220, 38, 38); // vermelho
                    } else if (["PA", "PS", "PSA"].includes(status)) {
                        doc.setTextColor(245, 158, 11); // amarelo/laranja
                    } else {
                        doc.setTextColor(100, 100, 100); // cinza
                    }
                    
                    // Centralizar o texto na célula
                    doc.text(status, xPos + 2, currentY + 4);
                    doc.setTextColor(0, 0, 0); // reset para preto
                    
                    // Borda vertical entre colunas
                    if (diaIndex < dias.length - 1) {
                        doc.setDrawColor(209, 213, 219);
                        doc.setLineWidth(0.1);
                        doc.line(xPos + colWidth, currentY, xPos + colWidth, currentY + lineHeight);
                    }
                });

                // Borda vertical inicial e final
                doc.setDrawColor(209, 213, 219);
                doc.setLineWidth(0.1);
                doc.line(10, currentY, 10, currentY + lineHeight);
                doc.line(doc.internal.pageSize.getWidth() - 10, currentY, doc.internal.pageSize.getWidth() - 10, currentY + lineHeight);
                doc.line(10 + nomeColWidth, currentY, 10 + nomeColWidth, currentY + lineHeight);

                currentY += lineHeight;

                // Verificar se precisa de nova página
                if (currentY + lineHeight > doc.internal.pageSize.getHeight() - 20) {
                    doc.addPage();
                    currentY = 20;
                    
                    // Recriar cabeçalho da planilha na nova página
                    doc.setFillColor(79, 70, 229);
                    doc.rect(10, currentY, doc.internal.pageSize.getWidth() - 20, lineHeight, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(9);
                    doc.setFont("helvetica", "bold");
                    doc.text("ALUNO", 12, currentY + 4);
                    
                    dias.forEach((dia, index) => {
                        const xPos = 12 + nomeColWidth + (index * colWidth);
                        doc.text(dia.dia.toString(), xPos + 1, currentY + 4);
                    });
                    
                    currentY += lineHeight;
                }
            });

            // Rodapé com legenda
            const legendaY = doc.internal.pageSize.getHeight() - 10;
            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text("Legenda: P = Presença | F = Falta | PA = Atraso | PS = Saída Antecipada | PSA = Atraso + Saída", 
                     10, legendaY);

            // Estatísticas
            const totalAlunos = alunos.length;
            const totalDiasUteis = dias.length;
            doc.text(`Total de Alunos: ${totalAlunos} | Dias Úteis: ${totalDiasUteis}`, 
                     doc.internal.pageSize.getWidth() - 10, legendaY, { align: "right" });

            // Salvar PDF
            const fileName = `relatorio_frequencia_${salaNome.replace(/\s+/g, '_')}_${mesNome}_${ano}.pdf`;
            doc.save(fileName);
            mostrarMsg('PDF gerado com sucesso!', 'accent');
        }

        // Fallback usando html2canvas
        async function gerarPDFFallback(doc, salaNome, mesNome, ano) {
            const tabelaContainer = document.getElementById("tabelaContainerRelatorio");
            
            // Criar clone para estilização de impressão
            const clone = tabelaContainer.cloneNode(true);
            clone.style.width = '100%';
            clone.style.backgroundColor = '#ffffff';
            
            // Aplicar estilos de impressão
            clone.querySelectorAll('*').forEach(el => {
                el.style.color = '#000000';
                if (el.tagName === 'TABLE') {
                    el.style.border = '1px solid #000000';
                    el.style.width = '100%';
                }
                if (el.tagName === 'TH' || el.tagName === 'TD') {
                    el.style.border = '1px solid #000000';
                    el.style.padding = '4px';
                    el.style.fontSize = '10px';
                }
                if (el.tagName === 'TH') {
                    el.style.backgroundColor = '#f0f0f0';
                    el.style.fontWeight = 'bold';
                }
            });

            document.body.appendChild(clone);
            clone.style.position = 'absolute';
            clone.style.left = '-9999px';

            const canvas = await html2canvas(clone, {
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                width: clone.scrollWidth,
                height: clone.scrollHeight
            });

            document.body.removeChild(clone);

            const imgData = canvas.toDataURL('image/png');
            const imgWidth = doc.internal.pageSize.getWidth() - 40;
            const imgHeight = (canvas.height * imgWidth) / canvas.width;

            doc.addImage(imgData, 'PNG', 20, 40, imgWidth, imgHeight);
            
            const fileName = `relatorio_frequencia_${salaNome.replace(/\s+/g, '_')}_${mesNome}_${ano}.pdf`;
            doc.save(fileName);
            mostrarMsg('PDF gerado com sucesso!', 'accent');
        }
    </script>
    <style>
        .status-btn {
            @apply px-3 py-2 rounded-lg text-white font-bold transition duration-200;
            width: 45px;
            text-align: center;
            cursor: pointer;
            user-select: none;
        }
        .status-P { background-color: #10B981; }
        .status-F { background-color: #DC2626; }
        .status-P:hover { background-color: #059669; }
        .status-F:hover { background-color: #B91C1C; }
    </style>
</head>
<body class="bg-dark-primary text-text-light min-h-screen">
    <div id="global-message" style="display: none;"></div>
    
    <div class="container mx-auto p-4">
        <header class="text-center mb-8">
            <h1 class="text-2xl sm:text-3xl font-bold text-secondary-accent mb-2">SISTEMA DE GESTÃO DE CONVIVÊNCIA ESCOLAR</h1>
            <h2 class="text-xl sm:text-2xl text-text-light font-light border-b border-gray-700 pb-2 inline-block">MÓDULO DE GESTÃO DE FREQUÊNCIA</h2>
            <div class="mt-4 flex flex-wrap justify-center gap-4">
                <button onclick="window.location.href='/'" class="border border-gray-600 hover:bg-gray-700 px-4 py-2 rounded-lg text-gray-300 transition">Voltar ao Menu Principal</button>
            </div>
        </header>

        <!-- Menu de Navegação -->
        <div class="bg-dark-secondary p-6 rounded-lg shadow-lg mb-6">
            <h3 class="text-lg font-semibold mb-4 text-accent">Navegação</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <button onclick="mostrarModulo('registro')" class="nav-btn bg-accent text-white px-4 py-3 rounded-lg font-semibold transition">
                    Registro de Frequência
                </button>
                <button onclick="mostrarModulo('atraso')" class="nav-btn bg-gray-700 text-gray-300 px-4 py-3 rounded-lg font-semibold transition hover:bg-gray-600">
                    Registro de Atraso
                </button>
                <button onclick="mostrarModulo('saida')" class="nav-btn bg-gray-700 text-gray-300 px-4 py-3 rounded-lg font-semibold transition hover:bg-gray-600">
                    Saída Antecipada
                </button>
                <button onclick="mostrarModulo('relatorio')" class="nav-btn bg-gray-700 text-gray-300 px-4 py-3 rounded-lg font-semibold transition hover:bg-gray-600">
                    Relatório Mensal
                </button>
            </div>
        </div>

        <!-- Área de Conteúdo dos Módulos -->
        <div id="area-conteudo">
            
            <!-- Módulo Menu Principal -->
            <div id="modulo-menu" class="bg-dark-secondary rounded-lg shadow-lg p-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 w-full">
                    <button onclick="mostrarModulo('registro')" 
                            class="flex flex-col items-center justify-center p-6 text-2xl font-bold bg-accent hover:bg-emerald-600 transition duration-200 ease-in-out rounded-lg shadow-xl transform hover:scale-[1.03] text-white">
                        <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2l4-4m5.618-4.016A11.955 11.955 0 0112 2.944c-.754 0-1.487.124-2.17.359L5.344 5.344A9.998 9.998 0 003 12a9.997 9.997 0 001.344 4.656l.044.072A11.95 11.95 0 0112 21.056c.754 0 1.487-.124 2.17-.359l4.486-1.547a9.998 9.998 0 001.002-3.136c.266-1.12.39-2.288.39-3.468c0-2.316-.628-4.512-1.8-6.438z"></path></svg>
                        REGISTRO DE FREQUÊNCIA
                        <span class="text-sm font-light opacity-80 mt-1">(Presença/Falta)</span>
                    </button>
                    
                    <button onclick="mostrarModulo('atraso')" 
                            class="flex flex-col items-center justify-center p-6 text-2xl font-bold bg-warning hover:bg-amber-600 transition duration-200 ease-in-out rounded-lg shadow-xl transform hover:scale-[1.03] text-white">
                        <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0a9 9 0 0118 0z"></path></svg>
                        REGISTRO DE ATRASO
                        <span class="text-sm font-light opacity-80 mt-1">(Chegada Após o Horário)</span>
                    </button>
                    
                    <button onclick="mostrarModulo('saida')" 
                            class="flex flex-col items-center justify-center p-6 text-2xl font-bold bg-danger hover:bg-red-700 transition duration-200 ease-in-out rounded-lg shadow-xl transform hover:scale-[1.03] text-white">
                        <svg class="w-10 h-10 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>
                        SAÍDA ANTECIPADA
                        <span class="text-sm font-light opacity-80 mt-1">(Saída Durante o Período)</span>
                    </button>

                    <button onclick="mostrarModulo('relatorio')" 
                            class="report-button flex flex-col items-center justify-center p-6 bg-indigo-600 text-white rounded-xl shadow-md border-0 hover:bg-indigo-700 transition duration-300 ease-in-out col-span-3">
                        <span class="text-4xl mb-2">📊</span>
                        <span class="text-xl font-bold text-center">RELATÓRIO DE FREQUÊNCIA</span>
                        <span class="text-sm opacity-80 mt-1 text-center">(Dados de presença e faltas)</span>
                    </button>
                </div>
            </div>

            <!-- Módulo Registro de Frequência -->
            <div id="modulo-registro" class="hidden bg-dark-secondary rounded-lg shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-6 text-accent">REGISTRO DE FREQUÊNCIA</h3>
                
                <div class="bg-dark-primary p-6 rounded-xl space-y-6 mb-6">
                    <h4 class="text-xl font-bold border-b border-gray-600 pb-3 text-secondary-accent">FILTROS</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="select-sala-registro" class="block text-sm font-medium text-gray-300 mb-1">Sala:</label>
                            <select id="select-sala-registro" class="select-sala w-full p-3 bg-gray-800 rounded border border-gray-700 text-white" required></select>
                        </div>
                        <div>
                            <label for="input-data-registro" class="block text-sm font-medium text-gray-300 mb-1">Data:</label>
                            <input id="input-data-registro" type="date" class="w-full p-3 bg-gray-800 rounded border border-gray-700 text-white" required>
                        </div>
                    </div>
                    <div id="registro-status" class="pt-2 text-center text-lg"></div>
                </div>

                <div id="alunos-list-container" class="bg-dark-primary p-6 rounded-xl hidden transition-all duration-300">
                    <h4 class="text-xl font-bold border-b border-gray-600 pb-3 text-secondary-accent">LISTA DE ALUNOS</h4>
                    <table class="w-full mt-4 border-collapse">
                        <thead class="text-left text-sm text-gray-400 border-b border-gray-700">
                            <tr>
                                <th class="p-3">Aluno</th>
                                <th class="p-3 text-center">Presença / Falta</th>
                            </tr>
                        </thead>
                        <tbody id="alunos-list-body"></tbody>
                    </table>
                    <button id="btn-salvar-frequencia" class="mt-6 bg-accent hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg w-full hidden">
                        Salvar Frequência
                    </button>
                </div>

                <div id="mensagem-travada" class="hidden bg-dark-primary p-6 mt-6 rounded-xl text-center border border-gray-600">
                    <h2 class="text-2xl font-extrabold text-accent mb-4">FREQUÊNCIA JÁ REGISTRADA</h2>
                    <p class="text-lg leading-relaxed text-gray-200">
                        A frequência desta <span class="text-secondary-accent font-bold">sala</span> e desta <span class="text-secondary-accent font-bold">data</span>
                        já foi registrada anteriormente.<br><br>
                        Para realizar qualquer alteração, utilize as telas:
                        <br>
                        <span class="text-accent font-semibold">Registro de Atraso</span> ou
                        <span class="text-accent font-semibold">Saída Antecipada</span>.
                    </p>
                </div>
            </div>

            <!-- Módulo Registro de Atraso -->
            <div id="modulo-atraso" class="hidden bg-dark-secondary rounded-lg shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-6 text-accent">REGISTRO DE ATRASO</h3>
                
                <form id="form-atraso" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Sala</label>
                            <select id="sala-atraso" class="select-sala w-full p-3 bg-gray-800 rounded border border-gray-700"></select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Aluno</label>
                            <select id="aluno-atraso" class="w-full p-3 bg-gray-800 rounded border border-gray-700"></select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Data</label>
                            <input id="data-atraso" type="date" class="w-full p-3 bg-gray-800 rounded border border-gray-700" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Hora do Atraso</label>
                            <input id="hora-atraso" type="time" class="w-full p-3 bg-gray-800 rounded border border-gray-700" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-300 mb-1">Motivo</label>
                        <textarea id="motivo-atraso" rows="2" class="w-full p-3 bg-gray-800 rounded border border-gray-700" placeholder="Descreva o motivo do atraso..."></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Responsável</label>
                            <input id="responsavel-atraso" type="text" class="w-full p-3 bg-gray-800 rounded border border-gray-700" placeholder="Nome do responsável pelo aluno" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Telefone</label>
                            <input id="telefone-atraso" type="tel" class="w-full p-3 bg-gray-800 rounded border border-gray-700" placeholder="(11) 99999-9999" />
                        </div>
                    </div>

                    <button type="button" id="btnSalvarAtraso" class="mt-4 px-4 py-2 rounded-lg bg-accent hover:bg-green-600 text-white font-semibold transition">
                        Salvar Atraso
                    </button>
                </form>
            </div>

            <!-- Módulo Saída Antecipada -->
            <div id="modulo-saida" class="hidden bg-dark-secondary rounded-lg shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-6 text-accent">SAÍDA ANTECIPADA</h3>
                
                <form id="form-saida" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Sala</label>
                            <select id="sala-saida" class="select-sala w-full p-3 bg-gray-800 rounded border border-gray-700"></select>
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Aluno</label>
                            <select id="aluno-saida" class="w-full p-3 bg-gray-800 rounded border border-gray-700"></select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Data</label>
                            <input id="data-saida" type="date" class="w-full p-3 bg-gray-800 rounded border border-gray-700" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Hora da Saída</label>
                            <input id="hora-saida" type="time" class="w-full p-3 bg-gray-800 rounded border border-gray-700" />
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm text-gray-300 mb-1">Motivo</label>
                        <textarea id="motivo-saida" rows="2" class="w-full p-3 bg-gray-800 rounded border border-gray-700" placeholder="Motivo da saída antecipada..."></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Responsável</label>
                            <input id="responsavel-saida" type="text" class="w-full p-3 bg-gray-800 rounded border border-gray-700" placeholder="Nome do responsável" />
                        </div>
                        <div>
                            <label class="block text-sm text-gray-300 mb-1">Telefone</label>
                            <input id="telefone-saida" type="tel" class="w-full p-3 bg-gray-800 rounded border border-gray-700" placeholder="(11) 99999-9999" />
                        </div>
                    </div>

                    <button type="button" id="btnSalvarSaida" class="mt-4 px-4 py-2 rounded-lg bg-accent hover:bg-green-600 text-white font-semibold transition">
                        Salvar Saída Antecipada
                    </button>
                </form>
            </div>

            <!-- Módulo Relatório Mensal -->
            <div id="modulo-relatorio" class="hidden bg-dark-secondary rounded-lg shadow-lg p-6">
                <h3 class="text-2xl font-bold mb-6 text-accent">RELATÓRIO MENSAL DE FREQUÊNCIA</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Sala</label>
                        <select id="salaSelectRelatorio" class="select-sala w-full p-3 bg-gray-800 rounded border border-gray-700"></select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-1">Mês</label>
                        <select id="mesSelectRelatorio" class="w-full p-3 bg-gray-800 rounded border border-gray-700"></select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnVisualizarRelatorio" class="w-full bg-accent hover:bg-green-600 text-white font-bold py-3 px-4 rounded-lg transition duration-200">
                            Visualizar Frequência
                        </button>
                    </div>
                </div>

                <div class="flex justify-end mb-4">
                    <button id="btnGerarPDFRelatorio" class="px-4 py-2 text-sm rounded-lg bg-accent hover:bg-green-600 text-white flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Gerar PDF
                    </button>
                </div>

                <div id="tabelaContainerRelatorio" class="overflow-x-auto text-center text-gray-400">
                    Selecione a sala e o mês para visualizar a frequência.
                </div>
            </div>

        </div>

        <footer class="w-full text-center mt-10 p-4 text-gray-400 text-sm border-t border-gray-800">
            <p class="mb-1 text-base font-medium">DESENVOLVEDOR: MARCELO ANDRÉ NOGUEIRA CARDES</p>
            <p class="text-xs font-light tracking-wide">LICENCIADO: E.E. PEI PROFESSORA IRENE DIAS RIBEIRO</p>
        </footer>
    </div>
</body>
</html>